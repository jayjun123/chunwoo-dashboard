<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chunwoo Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <!-- AdSense 스크립트 수정 -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg-main: #181c24;
      --bg-card: #232837;
      --bg-header: #232837;
      --text-main: #fff;
      --text-sub: #b3b8c5;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --danger: #ef4444;
      --success: #22c55e;
      --border: #2d3344;
      --radius: 12px;
      --shadow: 0 2px 16px rgba(0,0,0,0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Noto Sans KR', Arial, sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
    }
    header {
      background: var(--bg-header);
      box-shadow: var(--shadow);
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 1px;
    }
    nav {
      display: flex;
      gap: 18px;
      align-items: center;
    }
    nav a {
      color: var(--text-sub);
      text-decoration: none;
      font-weight: 500;
      font-size: 1rem;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s, color 0.2s;
    }
    nav a.active, nav a:hover {
      background: var(--primary);
      color: #fff;
    }
    .date {
      color: var(--text-sub);
      font-size: 0.95rem;
      margin-right: 16px;
    }
    .logout-btn {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 20px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    .logout-btn:hover {
      background: #b91c1c;
    }
    .container {
      max-width: 1400px;
      min-width: 360px;
      margin: 40px auto 0 auto;
      padding: 0 16px;
    }
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px 24px 24px 24px;
      margin-top: 40px;
      max-width: 1400px;
      min-width: 360px;
    }
    /* 로그인 박스 */
    .login-box {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 350px;
      margin: 80px auto;
      padding: 36px 28px 28px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .login-box h2 {
      color: var(--primary);
      margin-bottom: 24px;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .login-box input {
      width: 100%;
      padding: 12px 10px;
      margin-bottom: 16px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
      background: #181c24;
      color: #fff;
      transition: border 0.2s;
    }
    .login-box input:focus {
      border: 1.5px solid var(--primary);
    }
    .login-box button {
      width: 100%;
      padding: 12px 0;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.2s;
    }
    .login-btn {
      background: var(--primary);
      color: #fff;
    }
    .login-btn:hover {
      background: var(--primary-hover);
    }
    .error-msg {
      color: var(--danger);
      font-size: 0.98rem;
      margin-bottom: 10px;
      text-align: center;
    }
    /* 반응형 */
    @media (max-width: 900px) {
      .container { max-width: 100%; }
      nav { gap: 8px; }
      .card, .login-box { margin-top: 24px; }
    }
    @media (max-width: 600px) {
      header { flex-direction: column; height: auto; padding: 8px; }
      .container { padding: 0 4px; }
      .login-box { margin: 40px auto; }
    }
    /* 상태탭 스타일 개선 (head에 추가) */
    .status-tabs {
      display: flex;
      gap: 4px;
      justify-content: flex-start;
      margin-bottom: 18px;
      flex-wrap: nowrap;
      width: 100%;
      min-width: 0;
      overflow-x: auto;
      white-space: nowrap;
    }
    .status-tabs button,
    .status-tabs .tab {
      padding: 6px 12px !important;
      font-size: 1rem !important;
      border-radius: 16px !important;
      min-width: 0 !important;
    }
    .status-tab-btn {
      background: var(--bg-card);
      color: var(--text-sub);
      border: none;
      border-radius: 24px;
      padding: 14px 32px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: none;
      outline: none;
      position: relative;
    }
    .status-tab-btn.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 16px #3b82f655;
    }
    .status-tab-btn:hover:not(.active) {
      background: #232837;
      color: var(--primary);
    }
    /* 스크롤바 스타일 다크모드 */
    .site-list::-webkit-scrollbar {
      width: 8px;
      background: #232837;
    }
    .site-list::-webkit-scrollbar-thumb {
      background: #2d3344;
      border-radius: 6px;
    }
    .site-list {
      overflow-x: hidden !important;
      overflow-y: auto !important;
      max-height: 370px;
      padding-right: 4px;
    }
    /* 햄버거 버튼 기본 숨김 */
    .nav-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 2rem;
      color: var(--primary);
      margin-left: 12px;
      cursor: pointer;
    }
    /* 모바일에서만 햄버거 버튼 보이기, nav 숨기기 */
    @media (max-width: 700px) {
      nav {
        display: none !important;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100vw;
        background: var(--bg-header);
        flex-direction: column;
        gap: 0;
        z-index: 1001;
        box-shadow: var(--shadow);
      }
      nav.open {
        display: flex !important;
      }
      .nav-toggle {
        display: block;
      }
    }
  </style>
</head>
<body>
  <header id="header" style="display:none;">
    <span class="logo">Chunwoo</span>
    <nav id="nav"></nav>
    <button id="nav-toggle" class="nav-toggle" onclick="toggleMobileNav()" aria-label="메뉴 열기">&#9776;</button>
    <div style="display:flex;align-items:center;">
      <span class="date" id="today"></span>
      <button class="logout-btn" onclick="logout()">로그아웃</button>
    </div>
  </header>
  <main id="main"></main>
  <div id="popup-root"></div>
  <script>
   
    // 권한/계정 정보
    const USERS = [
      { id: "fire8803", pw: "power520", role: "master" },
      { id: "admin", pw: "8657", role: "admin" },
      { id: "user1", pw: "1111", role: "user" }
    ];
    const MENUS = [
      { key: "main", label: "Chunwoo", roles: ["master","admin","user"] },
      { key: "status", label: "공사현황", roles: ["master","admin","user"] },
      { key: "detail", label: "현장세부내역", roles: ["master","admin","user"] },
      { key: "negotiate", label: "협의하기", roles: ["master","admin","user"] },
      { key: "progress", label: "기성현황", roles: ["master","admin"] },
      { key: "partner", label: "거래처 현황", roles: ["master","admin","user"] },
      { key: "members", label: "회원명단", roles: ["master","admin"] },
      { key: "menuauth", label: "메뉴권한", roles: ["master"] },
      { key: "allmembers", label: "회원 전체 리스트", roles: ["master","admin"] },
    ];
    let currentUser = null;
    let currentMenu = "main";
    // 전역 변수 window에 바인딩
    window.selectedSite = null;
    window.isAddingNewSite = false;
    window.selectedStatusType = '예정';

    // 날짜 표시
    function setToday() {
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth()+1;
      const d = today.getDate();
      const w = ["일","월","화","수","목","금","토"][today.getDay()];
      document.getElementById("today").textContent = `${y}년 ${m}월 ${d}일 (${w})`;
    }

    // 로그인 화면
    function renderLogin() {
      document.getElementById("header").style.display = "none";
      document.getElementById("main").innerHTML = `
        <div class="login-box">
          <h2>로그인</h2>
          <input id="login-id" type="text" placeholder="아이디" autocomplete="username"/>
          <input id="login-pw" type="password" placeholder="비밀번호" autocomplete="current-password"/>
          <button class="login-btn" onclick="login()">로그인</button>
          <button class="signup-btn" onclick="renderSignup()">회원가입</button>
          <div class="error-msg" id="login-error"></div>
        </div>
      `;
      // 엔터키 이벤트 추가
      document.getElementById("login-pw").addEventListener("keydown", function(e) {
        if (e.key === "Enter") login();
      });
    }

    // 로그인 처리
    function login() {
      const id = document.getElementById("login-id").value.trim();
      const pw = document.getElementById("login-pw").value.trim();
      const user = USERS.find(u => u.id === id && u.pw === pw);
      if (!user) {
        document.getElementById("login-error").textContent = "아이디 또는 비밀번호가 올바르지 않습니다.";
        return;
      }
      currentUser = user;
      setToday();
      renderHeader();
      renderMenu("main");
    }

    // 로그아웃
    function logout() {
      currentUser = null;
      renderLogin();
    }

    // 헤더/네비게이션 렌더링
    function renderHeader() {
      document.getElementById("header").style.display = "flex";
      const nav = document.getElementById("nav");
      nav.innerHTML = "";
      MENUS.forEach(menu => {
        if(menu.key === 'allmembers') return; // 회원 전체 리스트 메뉴 숨김
        if (currentUser.role === 'user' && !['main','status','negotiate'].includes(menu.key)) return;
        if (menu.roles.includes(currentUser.role)) {
          const a = document.createElement("a");
          a.textContent = menu.key === "main" ? "건설NEWS" : menu.label;
          a.href = "#";
          a.className = (currentMenu === menu.key) ? "active" : "";
          a.onclick = (e) => {
            e.preventDefault();
            renderMenu(menu.key);
          };
          nav.appendChild(a);
        }
      });
    }

    // 각 화면 렌더링
    function renderMenu(menuKey) {
      currentMenu = menuKey;
      renderHeader();
      let html = "";
      switch(menuKey) {
        case "main":
          html = `<div class="container card"><h2>Today Construction News</h2><p>뉴스를 불러오는 중입니다...</p></div>`;
          break;
        case "status":
          html = renderStatus();
          break;
        case "detail":
          renderDetail();
          return;
        case "negotiate":
          renderNegotiate();
          return;
        case "progress":
          renderProgress();
          return;
        case "partner":
          renderPartner();
          return;
        case "members":
          renderMembers();
          return;
        case "menuauth":
          renderMenuAuth();
          return;
        case "allmembers":
          renderAllMembers();
          return;
        default:
          html = `<div class="container card"><h2>페이지 준비중</h2></div>`;
      }
      document.getElementById("main").innerHTML = html;
    }

    function renderStatus() {
      // 예시 현장 리스트
      let sites = JSON.parse(localStorage.getItem("sites") || "[]");
      if (sites.length === 0) {
        sites = [
          { name: "현장A", status: "진행중" },
          { name: "현장B", status: "진행중" },
          { name: "현장C", status: "진행중" }
        ];
        localStorage.setItem("sites", JSON.stringify(sites));
      }
      // 달력 데이터
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month+1, 0).getDate();
      // 월 표시 + 저장/삭제 버튼
      let calendar = `<div class=\"calendar\" style=\"width:100%;min-width:600px;min-height:480px;max-width:900px;margin:0 auto;\">
        <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;\">
          <span style=\"font-size:1.3rem;font-weight:700;\">${year}년 ${String(month+1).padStart(2,'0')}월</span>
          <span>
            <button onclick=\"saveCalendar()\" style=\"background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 16px;margin-right:8px;\">저장</button>
            <button onclick=\"deleteCalendar()\" style=\"background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 16px;\">삭제</button>
          </span>
        </div>
        <table style=\"width:100%;height:400px;table-layout:fixed;\"><thead><tr>`;
      const weekDays = ["일","월","화","수","목","금","토"];
      for (let i=0; i<7; i++) {
        calendar += `<th style=\"color:${i===0?'#ef4444':'#3b82f6'}\">${weekDays[i]}</th>`;
      }
      calendar += `</tr></thead><tbody><tr>`;
      let day = 1;
      let calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}") || {};
      for (let i=0; i<firstDay; i++) calendar += "<td></td>";
      for (let i=firstDay; i<7; i++) {
        calendar += renderCalendarCell(day, i, today, calendarData, sites);
        day++;
      }
      calendar += "</tr>";
      while (day <= lastDate) {
        calendar += "<tr>";
        for (let i=0; i<7; i++) {
          if (day > lastDate) { calendar += "<td></td>"; continue; }
          calendar += renderCalendarCell(day, i, today, calendarData, sites);
          day++;
        }
        calendar += "</tr>";
      }
      calendar += "</tbody></table></div>";

      // 진행중 현장 리스트
      let siteColors = ['#3b82f6', '#22c55e', '#f59e42', '#ef4444', '#a855f7', '#14b8a6', '#eab308'];
      let siteList = `<div class=\"site-list\"><b>진행중 현장 LIST</b>`;
      sites.filter(s=>s.status==="진행중").forEach((site, idx) => {
        const color = siteColors[idx % siteColors.length];
        siteList += `<div class=\"site-item\" draggable=\"true\" 
          ondragstart=\"onSiteDrag(event,'${site.name}')\" 
          ondblclick=\"showSitePopup('${site.name}', ${today.getDate()}, event, 'site', ${idx})\"
          style=\"background:${color};color:#fff;padding:8px;border-radius:6px;margin-bottom:8px;cursor:pointer;\">${site.name}</div>`;
      });
      siteList += `</div>`;

      // 추가사항 입력 박스 (같은 날 중복 입력 가능)
      siteList += `
        <div style=\"margin-top:50px;\">
          <b>추가사항</b>
          <form onsubmit=\"addExtra(event)\" style=\"margin-top:10px;display:flex;gap:8px;\">
            <input id=\"extra-input\" type=\"text\" placeholder=\"추가사항 입력\" style=\"flex:1;padding:8px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;\"/>
            <button type=\"submit\" style=\"background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:1.3rem;\">+</button>
          </form>
          <div id=\"extra-list\" style=\"margin-top:10px;\"></div>
        </div>
      `;

      // 2단 레이아웃 적용 (flex)
      return `<div class=\"container card\">
        <h2><span style='color:#3b82f6;font-weight:700;'></span> 공사현황</h2>
        <div style=\"display:flex; gap:32px; align-items:flex-start; min-height:400px;\">
          <div style=\"flex:0 0 220px;\">${siteList}</div>
          <div style=\"flex:1; display:flex; justify-content:center;\">${calendar}</div>
        </div>
      </div>`;
    }

    // 추가사항 입력 및 표시 함수 (드래그 가능)
    window.addExtra = function(e) {
      e.preventDefault();
      const input = document.getElementById('extra-input');
      const value = input.value.trim();
      if (!value) return;
      let extraList = JSON.parse(localStorage.getItem('extraList') || '[]');
      extraList.push({ value, date: new Date().toISOString().slice(0,10) });
      localStorage.setItem('extraList', JSON.stringify(extraList));
      input.value = '';
      renderExtraList();
    }
    function renderExtraList() {
      const extraList = JSON.parse(localStorage.getItem('extraList') || '[]');
      const today = new Date().toISOString().slice(0,10);
      const filtered = extraList.filter(e => e.date === today);
      document.getElementById('extra-list').innerHTML = filtered.map((e, idx) => {
        const isSelected = selectedItems.some(item => item.type === 'extra' && item.idx === idx);
        return `<div class='site-item' draggable='true' 
          ondragstart="onExtraDrag(event,'${e.value.replace(/'/g, "\\'")}',${idx})" 
          onclick="selectExtraItem(${idx})"
          style='background:#232837;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:6px;margin-bottom:8px;cursor:pointer;${isSelected ? 'outline:2px solid #ef4444;' : ''}'>
          <span>${e.value}</span>
          <button onclick="deleteExtra(${idx})" style='background:none;border:none;color:#ef4444;font-size:1.1rem;cursor:pointer;margin-left:8px;'>×</button>
        </div>`;
      }).join('');
    }
    // 공사현황 화면 진입 시 추가사항 리스트 렌더링
    if (currentMenu === 'status') setTimeout(renderExtraList, 100);

    // 추가사항 드래그 이벤트
    window.onExtraDrag = function(e, value, idx) {
      e.dataTransfer.setData('extra', value);
      e.dataTransfer.setData('extraIdx', idx);
    }

    // 선택된 항목 정보를 배열로 관리
    let selectedItems = [];

    // 선택 함수 개선 (중복 선택 가능)
    window.selectCalendarItem = function(day, type, idx) {
      const itemKey = `${day}-${type}-${idx}`;
      const isSelected = selectedItems.some(item => item.key === itemKey);
      
      if (isSelected) {
        // 이미 선택된 항목이면 선택 해제
        selectedItems = selectedItems.filter(item => item.key !== itemKey);
        const item = document.querySelector(`.calendar-item[data-day="${day}"][data-type="${type}"][data-idx="${idx}"]`);
        if (item) item.style.outline = 'none';
      } else {
        // 새로운 항목 선택
        selectedItems.push({ day, type, idx, key: itemKey });
        const item = document.querySelector(`.calendar-item[data-day="${day}"][data-type="${type}"][data-idx="${idx}"]`);
        if (item) item.style.outline = '2px solid #ef4444';
      }
    }

    // 추가사항 선택 함수 개선 (중복 선택 가능)
    window.selectExtraItem = function(idx) {
      const itemKey = `extra-${idx}`;
      const isSelected = selectedItems.some(item => item.key === itemKey);
      
      if (isSelected) {
        // 이미 선택된 항목이면 선택 해제
        selectedItems = selectedItems.filter(item => item.key !== itemKey);
        const item = document.querySelectorAll('.site-item')[idx];
        if (item) item.style.outline = 'none';
      } else {
        // 새로운 항목 선택
        selectedItems.push({ type: 'extra', idx, key: itemKey });
        const item = document.querySelectorAll('.site-item')[idx];
        if (item) item.style.outline = '2px solid #ef4444';
      }
    }

    // 삭제 버튼 함수 수정 (여러 항목 삭제 가능)
    window.deleteCalendar = function() {
      if (selectedItems.length === 0) {
        alert('삭제할 항목을 먼저 선택하세요!');
        return;
      }

      let calendarData = JSON.parse(localStorage.getItem('calendarData') || '{}') || {};
      
      // 선택된 항목들을 삭제
      selectedItems.forEach(item => {
        if (item.type === 'site' || item.type === 'extra') {
          if (!calendarData[item.day]) return;
          
          if (item.type === 'site') {
            let sites = calendarData[item.day].filter(x => typeof x === 'string');
            sites.splice(item.idx, 1);
            let extras = calendarData[item.day].filter(x => typeof x === 'object');
            calendarData[item.day] = [...sites, ...extras];
          } else if (item.type === 'extra') {
            let sites = calendarData[item.day].filter(x => typeof x === 'string');
            let extras = calendarData[item.day].filter(x => typeof x === 'object');
            extras.splice(item.idx, 1);
            calendarData[item.day] = [...sites, ...extras];
          }
        }
      });

      localStorage.setItem('calendarData', JSON.stringify(calendarData));
      selectedItems = []; // 선택 초기화
      renderMenu('status');
    }

    // 달력 셀 렌더링 함수 수정
    function renderCalendarCell(day, weekIdx, today, calendarData, sites) {
      const isToday = day === today.getDate() && today.getMonth() === new Date().getMonth() && today.getFullYear() === new Date().getFullYear();
      let color = weekIdx === 0 ? '#ef4444' : '#fff';
      if (isToday) color = '#3b82f6';
      
      let cellSites = (calendarData[day] || []).filter(x => typeof x === 'string');
      let cellExtras = (calendarData[day] || []).filter(x => typeof x === 'object' && x.extra);
      let siteColors = ['#3b82f6', '#22c55e', '#f59e42', '#ef4444', '#a855f7', '#14b8a6', '#eab308'];
      
      let siteTags = cellSites.map((siteName, idx) => {
        const sidx = sites.findIndex(s => s.name === siteName);
        const bg = siteColors[sidx % siteColors.length];
        const isSelected = selectedItems.some(item => item.day === day && item.type === 'site' && item.idx === idx);
        return `<div class="calendar-item" data-type="site" data-day="${day}" data-idx="${idx}"
          style="background:${bg};color:#fff;border-radius:4px;padding:2px 6px;margin:2px 0;font-size:0.95em;cursor:pointer;${isSelected ? 'outline:2px solid #ef4444;' : ''}"
          onclick="selectCalendarItem(${day}, 'site', ${idx})"
          ondblclick="showSitePopup('${siteName}', ${day}, event, 'site', ${idx})"
        >${siteName}</div>`;
      }).join('');

      let extraTags = cellExtras.map((e, idx) => {
        const isSelected = selectedItems.some(item => item.day === day && item.type === 'extra' && item.idx === idx);
        return `<div class="calendar-item" data-type="extra" data-day="${day}" data-idx="${idx}"
          style="background:#232837;color:#fff;border-radius:4px;padding:2px 6px;margin:2px 0;font-size:0.95em;cursor:pointer;${isSelected ? 'outline:2px solid #ef4444;' : ''}"
          onclick="selectCalendarItem(${day}, 'extra', ${idx})"
          ondblclick="showSitePopup('${e.extra}', ${day}, event, 'extra', ${idx})"
        >${e.extra}</div>`;
      }).join('');

      return `<td style="vertical-align:top; border:2px solid ${isToday ? '#ef4444' : '#2d3344'}; height:60px; position:relative;box-sizing:border-box;"
        ondragover="event.preventDefault()" ondrop="onSiteDrop(event,${day})">
        <div style="position:absolute;top:4px;right:8px;font-size:1rem;font-weight:700;color:${color}">${day}</div>
        <div style="margin-top:22px;">${siteTags}${extraTags}</div>
      </td>`;
    }

    // 드래그앤드롭 이벤트(현장/추가사항)
    window.onSiteDrag = function(e, name) {
      e.dataTransfer.setData("site", name);
    };
    window.onSiteDrop = function(e, day) {
      let calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}") || {};
      if (!calendarData[day]) calendarData[day] = [];
      const siteName = e.dataTransfer.getData("site");
      const extra = e.dataTransfer.getData("extra");
      const extraIdx = e.dataTransfer.getData('extraIdx');
      if (siteName) {
        // 중복 방지
        if (!calendarData[day].includes(siteName)) {
          calendarData[day].push(siteName);
        }
      }
      if (extra) {
        // 추가사항은 중복 허용
        calendarData[day].push({ extra });
        // 드래그앤드롭 시 추가사항 리스트에서 삭제
        if (typeof extraIdx !== 'undefined' && extraIdx !== null && extraIdx !== '') {
          let extraList = JSON.parse(localStorage.getItem('extraList') || '[]');
          extraList.splice(extraIdx, 1);
          localStorage.setItem('extraList', JSON.stringify(extraList));
          setTimeout(renderExtraList, 50);
        }
      }
      localStorage.setItem("calendarData", JSON.stringify(calendarData));
      renderMenu("status");
    };

    // 현장 더블클릭 시 팝업
    window.showSitePopup = function(siteName, day, event, type, idx) {
      // 기존 팝업 닫기
      closePopup();
      
      const popup = document.createElement("div");
      popup.className = "popup-bg";
      popup.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;";
      popup.innerHTML = `
        <div class="popup" style="position:absolute;left:${event.clientX}px;top:${event.clientY}px;background:var(--bg-card);padding:20px;border-radius:var(--radius);min-width:200px;">
          <button class="close-btn" onclick="closePopup()" style="position:absolute;right:10px;top:10px;background:none;border:none;color:var(--text-sub);font-size:1.2rem;cursor:pointer;">&times;</button>
          <h3 style="margin:0 0 16px 0;color:var(--text-main);">${new Date().getFullYear()}년 ${String(new Date().getMonth()+1).padStart(2,'0')}월 ${day}일</h3>
          <p style="margin:8px 0;color:var(--text-main);"><b>${type === 'site' ? '현장명' : '추가사항'}:</b> ${siteName}</p>
          <p style="margin:8px 0;color:var(--text-sub);">상세 정보 및 연동 예정</p>
          <div style="margin-top:16px;display:flex;gap:10px;">
            <button onclick="goToMenu('progress')" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">기성현황 가기</button>
            <button onclick="goToDetailWithSite('${siteName}')" style="background:var(--success);color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">세부내역 가기</button>
          </div>
        </div>
      `;
      
      // 팝업 외부 클릭 시 닫기
      popup.onclick = function(e) {
        if (e.target === popup) closePopup();
      };
      
      document.getElementById("popup-root").appendChild(popup);
      // 자동 선택
      window.selectCalendarItem(day, type, idx);
    };

    window.closePopup = function() {
      const popupRoot = document.getElementById("popup-root");
      if (popupRoot) {
        popupRoot.innerHTML = "";
      }
    };

    // 캘린더 이벤트 위임 (렌더 후 실행)
    function bindCalendarEvents() {
      document.querySelectorAll('.calendar td').forEach((td, dayIdx) => {
        td.querySelectorAll('.calendar-item').forEach((item, idx) => {
          // 클릭(선택)
          item.onclick = function(e) {
            e.stopPropagation();
            const type = item.getAttribute('data-type');
            window.selectCalendarItem(dayIdx + 1, type, idx);
          };
          // 더블클릭(팝업)
          item.ondblclick = function(e) {
            e.stopPropagation();
            const type = item.getAttribute('data-type');
            const text = item.textContent;
            window.showSitePopup(text, dayIdx + 1, e, type, idx);
          };
        });
      });
    }

    // renderMenu('status') 호출 후에 항상 실행
    if (currentMenu === 'status') setTimeout(bindCalendarEvents, 150);

    // 저장 버튼 함수 구현
    window.saveCalendar = function() {
      // 현재 달력 데이터 가져오기
      let calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}") || {};
      
      // 진행중 현장 리스트 가져오기
      let sites = JSON.parse(localStorage.getItem("sites") || "[]");
      
      // 추가사항 리스트 가져오기
      let extraList = JSON.parse(localStorage.getItem("extraList") || "[]");
      
      // 모든 데이터를 하나의 객체로 저장
      const saveData = {
        calendarData,
        sites,
        extraList,
        lastSaved: new Date().toISOString()
      };
      
      // localStorage에 저장
      localStorage.setItem("saveData", JSON.stringify(saveData));
      
      // 저장 완료 메시지
      alert("모든 데이터가 저장되었습니다!");
    }

    // 페이지 로드 시 저장된 데이터 복원
    function loadSavedData() {
      const saveData = JSON.parse(localStorage.getItem("saveData") || "{}");
      if (saveData.calendarData) {
        localStorage.setItem("calendarData", JSON.stringify(saveData.calendarData));
      }
      if (saveData.sites) {
        localStorage.setItem("sites", JSON.stringify(saveData.sites));
      }
      if (saveData.extraList) {
        localStorage.setItem("extraList", JSON.stringify(saveData.extraList));
      }
    }

    // 최초 진입 시 저장된 데이터 로드
    loadSavedData();

    // 최초 진입
    renderLogin();

    // 전체 리스트 화면 렌더링 (검색, 선택, 다운로드/업로드/삭제/돌아가기)
    function renderSiteList() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let searchValue = window.siteListSearchValue || '';
      let selectedRows = window.siteListSelectedRows || [];
      // 검색 필터
      let filteredSites = sites.filter(site => {
        const d = siteDetails[site.name] || {};
        const keyword = searchValue.trim().toLowerCase();
        return (
          site.name.toLowerCase().includes(keyword) ||
          (d.manager||'').toLowerCase().includes(keyword) ||
          (d.team||'').toLowerCase().includes(keyword)
        );
      });
      // 테이블 헤더
      let html = `<div class="container card">
        <h2>전체 현장 리스트 (데이터베이스 1번)</h2>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:8px;">
            <input id="site-list-search" type="text" placeholder="현장명, 담당자, 시공팀 검색" value="${searchValue||''}" style="padding:8px 14px;border-radius:6px;border:1.5px solid #2d3344;background:#232837;color:#fff;font-size:1rem;width:220px;" onkeyup="window.siteListSearchValue=this.value;renderSiteList()">
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="downloadSiteTemplate()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">양식 다운로드</button>
            <input type="file" id="site-upload" accept=".csv" style="display:none;" onchange="uploadSiteCSV(event)">
            <button onclick="document.getElementById('site-upload').click()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">업로드</button>
            <button onclick="downloadSelectedSites()" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">선택 내려받기</button>
            <button onclick="deleteSelectedSites()" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">선택 삭제</button>
            <button onclick="renderMenu('detail')" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">돌아가기</button>
          </div>
        </div>
        <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:var(--bg-header);color:#fff;">
              <th style="padding:8px 6px;border-bottom:2px solid var(--border);"><input type="checkbox" id="site-list-select-all" onclick="toggleSelectAllSites(this)"></th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">현장명</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">상태</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">착공일</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">준공예정일</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">계약구분</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">시공팀</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">주소</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">담당자(소장)</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">연락처</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">내용</th>
            </tr>
          </thead>
          <tbody>
            ${filteredSites.map(site => {
              const d = siteDetails[site.name] || {};
              const checked = selectedRows && selectedRows.includes(site.name) ? 'checked' : '';
              return `<tr style="background:var(--bg-card);color:#fff;">
                <td style="padding:8px 6px;border-bottom:1px solid var(--border);text-align:center;"><input type="checkbox" class="site-list-row-check" value="${site.name}" ${checked} onclick="toggleSelectSiteRow('${site.name}')"></td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${site.name}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.status || site.status || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.startDate || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.endDate || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.contract || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.team || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.address || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.manager || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);">${d.phone || ''}</td>
                <td style="padding:8px 12px;border-bottom:1px solid var(--border);white-space:pre-line;">${(d.contentsTable||[]).filter(r=>r.item||r.qty||r.price).map(r=>`${r.item} / ${r.qty} / ${r.price}`).join('<br>')}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
        </div>
      </div>`;
      document.getElementById('main').innerHTML = html;
    }

    // 전체선택 체크박스
    window.toggleSelectAllSites = function(checkbox) {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let searchValue = window.siteListSearchValue || '';
      let filteredSites = sites.filter(site => {
        const d = siteDetails[site.name] || {};
        const keyword = searchValue.trim().toLowerCase();
        return (
          site.name.toLowerCase().includes(keyword) ||
          (d.manager||'').toLowerCase().includes(keyword) ||
          (d.team||'').toLowerCase().includes(keyword)
        );
      });
      if (checkbox.checked) {
        window.siteListSelectedRows = filteredSites.map(site => site.name);
      } else {
        window.siteListSelectedRows = [];
      }
      renderSiteList();
    }
    // 개별 체크박스
    window.toggleSelectSiteRow = function(name) {
      window.siteListSelectedRows = window.siteListSelectedRows || [];
      if (window.siteListSelectedRows.includes(name)) {
        window.siteListSelectedRows = window.siteListSelectedRows.filter(n => n !== name);
      } else {
        window.siteListSelectedRows.push(name);
      }
      renderSiteList();
    }
    // 양식 다운로드 (CSV)
    window.downloadSiteTemplate = function() {
      const header = ['현장명','상태','착공일','준공예정일','계약구분','시공팀','주소','담당자(소장)','연락처','내용(항목/물량/단가;...복수행)'];
      const csv = header.join(',') + '\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '현장_양식.csv';
      link.click();
    }
    // 선택 내려받기 (CSV)
    window.downloadSelectedSites = function() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let selected = window.siteListSelectedRows || [];
      const header = ['현장명','상태','착공일','준공예정일','계약구분','시공팀','주소','담당자(소장)','연락처','내용(항목/물량/단가;...복수행)'];
      let rows = sites.filter(site => selected.includes(site.name)).map(site => {
        const d = siteDetails[site.name] || {};
        const contents = (d.contentsTable||[]).filter(r=>r.item||r.qty||r.price).map(r=>`${r.item}/${r.qty}/${r.price}`).join(';');
        return [site.name, d.status||site.status||'', d.startDate||'', d.endDate||'', d.contract||'', d.team||'', d.address||'', d.manager||'', d.phone||'', contents].map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',');
      });
      const csv = header.join(',') + '\n' + rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '선택_현장리스트.csv';
      link.click();
    }
    // 업로드 (CSV)
    window.uploadSiteCSV = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(Boolean);
        if (lines.length < 2) return alert('데이터가 없습니다.');
        const header = lines[0].split(',');
        let sites = JSON.parse(localStorage.getItem('sites') || '[]');
        let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
        for (let i=1; i<lines.length; i++) {
          const cols = lines[i].split(',').map(s=>s.replace(/^"|"$/g,''));
          const [name, status, startDate, endDate, contract, team, address, manager, phone, contents] = cols;
          if (!name) continue;
          if (!sites.find(s=>s.name===name)) sites.push({ name, status });
          siteDetails[name] = { name, status, startDate, endDate, contract, team, address, manager, phone, contentsTable: (contents||'').split(';').filter(Boolean).map(row=>{
            const [item,qty,price] = row.split('/');
            return {item,qty,price};
          }) };
        }
        localStorage.setItem('sites', JSON.stringify(sites));
        localStorage.setItem('siteDetails', JSON.stringify(siteDetails));
        alert('업로드 완료!');
        renderSiteList();
      };
      reader.readAsText(file);
    }
    // 선택 삭제 (sites, siteDetails 등 모든 데이터에서 삭제)
    window.deleteSelectedSites = function() {
      let selected = window.siteListSelectedRows || [];
      if (!selected.length) return alert('삭제할 현장을 선택하세요!');
      if (!confirm('정말 삭제하시겠습니까?')) return;
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      // 삭제
      sites = sites.filter(site => !selected.includes(site.name));
      selected.forEach(name => { delete siteDetails[name]; });
      localStorage.setItem('sites', JSON.stringify(sites));
      localStorage.setItem('siteDetails', JSON.stringify(siteDetails));
      window.siteListSelectedRows = [];
      alert('삭제되었습니다.');
      renderSiteList();
    }

    // 현장세부내역 화면 렌더링 함수 복구
    function renderDetail() {
      let sites = JSON.parse(localStorage.getItem("sites") || "[]");
      let siteDetails = JSON.parse(localStorage.getItem("siteDetails") || "{}");
      const statusTypes = ['진행중', '예정', '완료', '보류'];
      // 상태탭 항상 상단에 고정
      let statusTabs = `<div class='status-tabs'>${statusTypes.map(type => `
        <button type="button"
          onclick="selectStatusType('${type}')"
          style="
            background:${window.selectedStatusType===type ? 'var(--primary)' : 'var(--bg-card)'};
            color:${window.selectedStatusType===type ? '#fff' : 'var(--text-sub)'};
            border:none;
            border-radius:18px;
            padding:6px 18px;
            font-size:1rem;
            font-weight:700;
            cursor:pointer;
            transition:background 0.2s,color 0.2s;
            box-shadow:${window.selectedStatusType===type ? '0 4px 16px #3b82f655' : 'none'};
            white-space:nowrap;
            min-width:auto;
            height:auto;
            line-height:1.2;
          ">
          ${type}
        </button>`).join('')}
      </div>`;
      // 상단 헤더(현장 상세 정보 + 상태탭 + 전체 리스트 버튼)
      let headerRow = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
          <h3 style="margin:0;color:var(--text-main);font-size:1.5rem;font-weight:700;">현장 상세 정보</h3>
          <button onclick="renderSiteList()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:10px 24px;font-size:1rem;font-weight:700;">전체 리스트</button>
        </div>
      `;
      // siteList: 상태탭 + 현장 목록
      let siteList = `<div class="site-list" style="flex:0 0 250px;margin-right:24px;">
        ${statusTabs}
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;color:var(--text-main);">현장 목록</h3>
          <button onclick="addNewSite()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;">+ 새 현장</button>
        </div>
        <div style="max-height:600px;overflow-y:auto;">`;
      sites.filter(site => (siteDetails[site.name]?.status || site.status || '예정') === window.selectedStatusType)
        .forEach((site, idx) => {
        const isSelected = window.selectedSite === site.name;
        siteList += `<div class="site-item" onclick="selectSite('${site.name}')"
          style="background:${isSelected ? 'var(--primary)' : 'var(--bg-card)'};color:#fff;padding:12px;border-radius:6px;margin-bottom:8px;cursor:pointer;">
          ${site.name}
        </div>`;
      });
      siteList += `</div></div>`;
      // 상세정보 입력 폼
      let detail = (window.isAddingNewSite ? {} : (window.selectedSite && siteDetails[window.selectedSite]) ? siteDetails[window.selectedSite] : {});
      const contractTypes = ['하도급','납품','NONE'];
      // 수정모드 상태
      window.isEditingSite = window.isEditingSite || false;
      // 현장상황 select
      const statusSelect = `<select id="site-status" onchange="updateSiteStatus(this.value)" style="margin-left:8px;width:auto;padding:8px 16px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;">
        ${statusTypes.map(type => `<option value="${type}" ${(detail.status||'') === type ? 'selected' : ''}>${type}</option>`).join('')}
      </select>`;
      // 내용(표) 데이터
      let tableRows = (detail.contentsTable && Array.isArray(detail.contentsTable) && detail.contentsTable.length > 0 ? detail.contentsTable : [{item:'',qty:'',price:''}]).map((row,idx)=>`
        <tr>
          <td><input type='text' class='table-item' value='${row.item||''}' style='width:100%;padding:6px 8px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:var(--text-main);' ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}></td>
          <td><input type='text' class='table-qty' value='${row.qty||''}' style='width:100%;padding:6px 8px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:var(--text-main);text-align:right;' ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}></td>
          <td><input type='text' class='table-price' value='${row.price||''}' style='width:100%;padding:6px 8px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:var(--text-main);text-align:right;' ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}></td>
          <td><button onclick='removeTableRow(${idx})' style='background:var(--danger);color:#fff;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;' ${window.isAddingNewSite||window.isEditingSite?'':'disabled'}>삭제</button></td>
        </tr>
      `).join('');
      // 기성현황 누적(전회기성) 계산
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      let prevProgress = 0;
      if (window.selectedSite) {
        prevProgress = progressList
          .filter(row => row.site === window.selectedSite)
          .reduce((sum, row) => sum + (parseInt(row.amount, 10) || 0), 0);
      }
      let detailContent = `<div class="detail-content" style="flex:1;">
        ${headerRow}
        <div id="site-detail-form" style="display:${window.selectedSite || window.isAddingNewSite ? 'block' : 'none'};max-width:700px;">
          <div style="margin-bottom:18px;display:flex;gap:12px;align-items:center;">
            <div style="flex:1;">
              <label style="display:block;margin-bottom:8px;color:var(--text-sub);">현장명</label>
              <input type="text" id="site-name" value="${detail.name || ''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
            </div>
            <div style="flex:1;">
              <label style="display:block;margin-bottom:8px;color:var(--text-sub);">계약구분</label>
              <select id="site-contract" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'disabled'}>
                ${contractTypes.map(type => `<option value="${type}" ${(detail.contract||'')===type?'selected':''}>${type}</option>`).join('')}
              </select>
            </div>
            <div style="flex:1;">
              <label style="display:block;margin-bottom:8px;color:var(--text-sub);">현장상황</label>
              ${statusSelect}
            </div>
          </div>
          <div style="margin-bottom:18px;display:flex;gap:12px;align-items:center;">
            <div style="flex:1;">
              <label style="display:block;margin-bottom:8px;color:var(--text-sub);">계약금액</label>
              <input type="number" id="site-contract-amount" value="${detail.contractAmount || ''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
            </div>
            <div style="flex:1;">
              <label style="display:block;margin-bottom:8px;color:var(--text-sub);">선급금</label>
              <input type="number" id="site-advance-amount" value="${detail.advanceAmount || ''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
            </div>
            <div style="flex:1;">
              <label style="display:block;margin-bottom:8px;color:var(--text-sub);">전회기성</label>
              <input type="number" id="site-prev-progress" value="${prevProgress || 0}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" readonly>
            </div>
          </div>
          <div style="margin-bottom:18px;display:flex;gap:12px;align-items:center;">
            <div style="flex:1;display:flex;align-items:center;gap:8px;">
              <label style="color:var(--text-sub);min-width:70px;">착공일</label>
              <input type="date" id="site-start-date" value="${detail.startDate || ''}" style="flex:1;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
            </div>
            <div style="flex:1;display:flex;align-items:center;gap:8px;">
              <label style="color:var(--text-sub);min-width:90px;">준공예정일</label>
              <input type="date" id="site-end-date" value="${detail.endDate || ''}" style="flex:1;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
            </div>
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-sub);">현장 주소</label>
            <input type="text" id="site-address" value="${detail.address || ''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-sub);">현장 설명</label>
            <textarea id="site-description" style="width:100%;height:100px;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);resize:vertical;font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>${detail.description || ''}</textarea>
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-sub);">담당자(소장)</label>
            <input type="text" id="site-manager" value="${detail.manager || ''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
          </div>
          <div style="margin-bottom:18px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-sub);">연락처</label>
            <input type="tel" id="site-phone" value="${detail.phone || ''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;" ${window.isAddingNewSite||window.isEditingSite?'':'readonly'}>
          </div>
          <div style="margin-bottom:28px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-sub);">내용</label>
            <table style='width:100%;border-collapse:collapse;background:var(--bg-main);'>
              <thead>
                <tr style='background:#e5eaf2;color:#222;font-size:1.05rem;'>
                  <th style='padding:8px 0;border-bottom:2px solid #d1d5db;'>항목</th>
                  <th style='padding:8px 0;border-bottom:2px solid #d1d5db;'>물량</th>
                  <th style='padding:8px 0;border-bottom:2px solid #d1d5db;'>단가</th>
                  <th style='padding:8px 0;border-bottom:2px solid #d1d5db;'></th>
                </tr>
              </thead>
              <tbody id='site-contents-table'>
                ${tableRows}
              </tbody>
            </table>
            <button onclick='addTableRow()' style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 18px;cursor:pointer;margin-top:8px;font-size:1rem;' ${window.isAddingNewSite||window.isEditingSite?'':'disabled'}>+ 행 추가</button>
          </div>
          <div style="display:flex;gap:12px;justify-content:flex-end;align-items:center;">
            ${window.isAddingNewSite ? `
              <button onclick="registerNewSite()" style="background:var(--success);color:#fff;border:none;border-radius:6px;padding:12px 32px;font-size:1.1rem;font-weight:700;">등록하기</button>
              <button onclick="cancelNewSite()" style="background:var(--danger);color:#fff;border:none;border-radius:6px;padding:12px 32px;font-size:1.1rem;font-weight:700;">취소하기</button>
            ` : window.selectedSite ? `
              ${window.isEditingSite ? `<button onclick="saveEditSite()" style="background:var(--success);color:#fff;border:none;border-radius:6px;padding:12px 32px;font-size:1.1rem;font-weight:700;">저장하기</button>` : `<button onclick="editSite()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:12px 32px;font-size:1.1rem;font-weight:700;">수정하기</button>`}
              <button onclick="alert('기성현황 화면과 연동 예정입니다.')" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:12px 32px;font-size:1.1rem;font-weight:700;">기성현황</button>
            ` : ''}
          </div>
        </div>
        <div id="no-site-selected" style="display:${window.selectedSite || window.isAddingNewSite ? 'none' : 'block'};text-align:center;color:var(--text-sub);padding:48px;">
          현장을 선택하거나 새 현장을 추가해주세요.
        </div>
      </div>`;
      // flex 배치
      document.getElementById('main').innerHTML = `<div class="container card" style="max-width:1400px;min-width:360px;">
        <h2>현장세부내역</h2>
        <div style="display:flex;gap:32px;margin-top:24px;min-width:900px;max-width:1400px;">
          ${siteList}
          ${detailContent}
        </div>
      </div>`;
    }

    // 현장 선택 함수
    window.selectSite = function(siteName) {
      window.selectedSite = siteName;
      window.isAddingNewSite = false;
      renderMenu('detail');
    }

    // 새 현장 추가 함수
    window.addNewSite = function() {
      window.isAddingNewSite = true;
      window.selectedSite = null;
      renderMenu('detail');
    }

    // 상태 타입 선택 함수
    window.selectStatusType = function(type) {
      window.selectedStatusType = type;
      renderMenu('detail');
    }

    // 새 현장 등록 함수
    window.registerNewSite = function() {
      const name = document.getElementById('site-name').value.trim();
      if (!name) {
        alert('현장명을 입력해주세요.');
        return;
      }
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      if (sites.some(site => site.name === name)) {
        alert('이미 존재하는 현장명입니다.');
        return;
      }
      sites.push({ name, status: window.selectedStatusType });
      siteDetails[name] = {
        name,
        status: window.selectedStatusType,
        contract: document.getElementById('site-contract').value,
        team: document.getElementById('site-team').value,
        startDate: document.getElementById('site-start-date').value,
        endDate: document.getElementById('site-end-date').value,
        address: document.getElementById('site-address').value,
        description: document.getElementById('site-description').value,
        manager: document.getElementById('site-manager').value,
        phone: document.getElementById('site-phone').value,
        contractAmount: document.getElementById('site-contract-amount').value,
        advanceAmount: document.getElementById('site-advance-amount').value,
        prevProgress: document.getElementById('site-prev-progress').value,
        contentsTable: Array.from(document.querySelectorAll('#site-contents-table tr')).map(row => ({
          item: row.querySelector('.table-item').value,
          qty: row.querySelector('.table-qty').value,
          price: row.querySelector('.table-price').value
        }))
      };
      localStorage.setItem('sites', JSON.stringify(sites));
      localStorage.setItem('siteDetails', JSON.stringify(siteDetails));
      window.selectedSite = name;
      window.isAddingNewSite = false;
      renderMenu('detail');
    }

    // 테이블 행 추가/삭제 함수
    window.addTableRow = function() {
      const tbody = document.getElementById('site-contents-table');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type='text' class='table-item' style='width:100%;padding:6px 8px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:var(--text-main);'></td>
        <td><input type='text' class='table-qty' style='width:100%;padding:6px 8px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:var(--text-main);text-align:right;'></td>
        <td><input type='text' class='table-price' style='width:100%;padding:6px 8px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:var(--text-main);text-align:right;'></td>
        <td><button onclick='removeTableRow(${tbody.children.length})' style='background:var(--danger);color:#fff;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;' ${window.isAddingNewSite||window.isEditingSite?'':'disabled'}>삭제</button></td>
      `;
      tbody.appendChild(newRow);
    }

    window.removeTableRow = function(idx) {
      const tbody = document.getElementById('site-contents-table');
      if (tbody.children.length > 1 && tbody.children[idx]) {
        tbody.removeChild(tbody.children[idx]);
      } else if (tbody.children.length === 1) {
        // 마지막 행은 값만 비우기
        const row = tbody.children[0];
        if (row) {
          row.querySelector('.table-item').value = '';
          row.querySelector('.table-qty').value = '';
          row.querySelector('.table-price').value = '';
        }
      }
    }

    // 현장상황 실시간 반영
    window.updateSiteStatus = function(newStatus) {
      if (window.isAddingNewSite) return; // 새 현장 등록 중에는 반영하지 않음
      if (!window.selectedSite) return;
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      // sites 배열에도 반영
      sites = sites.map(site => site.name === window.selectedSite ? { ...site, status: newStatus } : site);
      if (!siteDetails[window.selectedSite]) siteDetails[window.selectedSite] = {};
      siteDetails[window.selectedSite].status = newStatus;
      localStorage.setItem('sites', JSON.stringify(sites));
      localStorage.setItem('siteDetails', JSON.stringify(siteDetails));
      renderDetail();
    }
    // 수정모드 진입
    window.editSite = function() {
      window.isEditingSite = true;
      renderDetail();
    }
    // 수정 저장
    window.saveEditSite = function() {
      const name = document.getElementById('site-name').value.trim();
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      if (!window.selectedSite || !siteDetails[window.selectedSite]) return;
      // 기존 이름이 바뀌면 이름 중복 체크
      if (name !== window.selectedSite && sites.some(site => site.name === name)) {
        alert('이미 존재하는 현장명입니다.');
        return;
      }
      // sites 배열에서 이름/상태 등 변경
      sites = sites.map(site => site.name === window.selectedSite ? { ...site, name, status: document.getElementById('site-status').value } : site);
      // 상세 정보 변경
      siteDetails[name] = {
        name,
        status: document.getElementById('site-status').value,
        contract: document.getElementById('site-contract').value,
        team: document.getElementById('site-team').value,
        startDate: document.getElementById('site-start-date').value,
        endDate: document.getElementById('site-end-date').value,
        address: document.getElementById('site-address').value,
        description: document.getElementById('site-description').value,
        manager: document.getElementById('site-manager').value,
        phone: document.getElementById('site-phone').value,
        contractAmount: document.getElementById('site-contract-amount').value,
        advanceAmount: document.getElementById('site-advance-amount').value,
        prevProgress: document.getElementById('site-prev-progress').value,
        contentsTable: Array.from(document.querySelectorAll('#site-contents-table tr')).map(row => ({
          item: row.querySelector('.table-item').value,
          qty: row.querySelector('.table-qty').value,
          price: row.querySelector('.table-price').value
        }))
      };
      // 이름이 바뀌면 기존 데이터 삭제
      if (name !== window.selectedSite) {
        delete siteDetails[window.selectedSite];
        window.selectedSite = name;
      }
      localStorage.setItem('sites', JSON.stringify(sites));
      localStorage.setItem('siteDetails', JSON.stringify(siteDetails));
      window.isEditingSite = false;
      alert('저장되었습니다.');
      renderDetail();
    }
    // 새 현장 취소
    window.cancelNewSite = function() {
      window.isAddingNewSite = false;
      window.selectedSite = null;
      renderDetail();
    }

    // 세부내역 가기 버튼에서 현장명 선택 후 이동
    window.goToDetailWithSite = function(siteName) {
      window.selectedSite = siteName;
      window.isAddingNewSite = false;
      window.isEditingSite = false;
      closePopup();
      renderMenu('detail');
    }

    // 협의하기(채팅) 화면 렌더링
    function renderNegotiate() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      if (sites.length === 0) {
        document.getElementById('main').innerHTML = `<div class="container card"><h2>협의하기</h2><p>등록된 현장이 없습니다.</p></div>`;
        return;
      }
      window.selectedNegotiateSite = window.selectedNegotiateSite || sites[0].name;
      let chatKey = 'chat_' + window.selectedNegotiateSite;
      let chatList = JSON.parse(localStorage.getItem(chatKey) || '[]');
      // 현장 리스트(좌측)
      let siteListHtml = `<div class="site-list" style="width:220px;max-height:370px;overflow-y:auto;overflow-x:hidden;background:var(--bg-card);border-radius:12px;padding:18px 10px 10px 10px;box-sizing:border-box;">`;
      sites.forEach(site => {
        let chatKey = 'chat_' + site.name;
        let msgCount = (JSON.parse(localStorage.getItem(chatKey) || '[]')).length;
        let remarksKey = 'remarks_' + site.name;
        let remarks = localStorage.getItem(remarksKey) || '';
        let isSelected = window.selectedNegotiateSite === site.name;
        siteListHtml += `<div style="background:${isSelected ? 'var(--primary)' : 'var(--bg-main)'};color:#fff;border-radius:8px;padding:10px 10px 8px 10px;margin-bottom:10px;cursor:pointer;box-shadow:${isSelected ? '0 2px 8px #3b82f655' : 'none'};" onclick="changeNegotiateSite('${site.name}')">
          <div style="font-weight:700;font-size:1.08rem;">${site.name}</div>
          <div style="font-size:0.98rem;color:var(--text-sub);margin:2px 0 4px 0;">글 수: <b style='color:#fff;'>${msgCount}</b></div>
          <div style="font-size:0.97rem;display:flex;align-items:center;gap:4px;">
            <span style="color:var(--text-sub);">비고:</span>
            ${(currentUser.role==='master'||currentUser.role==='admin')
              ? `<input type='text' value='${remarks}' onchange="updateRemarks('${site.name}', this.value)" style="flex:1;min-width:0;width:100%;max-width:120px;padding:2px 6px;border-radius:4px;border:1px solid #2d3344;background:var(--bg-main);color:#fff;font-size:0.97rem;">`
              : `<span style='color:#fff;'>${remarks}</span>`}
          </div>
        </div>`;
      });
      siteListHtml += `</div>`;
      // 상단 전체리스트 버튼
      let topRightBtn = `<div style="position:absolute;right:32px;top:32px;"><button onclick="renderNegotiateList()" style="background:var(--primary);color:#fff;border:none;border-radius:8px;padding:8px 22px;font-size:1.05rem;font-weight:700;cursor:pointer;">전체리스트</button></div>`;
      // 채팅 UI (우측)
      let html = `<div class="container card" style="max-width:900px;display:flex;gap:32px;align-items:flex-start;position:relative;">
        ${topRightBtn}
        ${siteListHtml}
        <div style="flex:1;min-width:0;">
          <h2>협의하기</h2>
          <div style="margin-bottom:18px;">
            <label style="color:var(--text-sub);margin-right:8px;">현장 선택</label>
            <select id="negotiate-site-select" style="padding:8px 16px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.05rem;" onchange="changeNegotiateSite(this.value)">
              ${sites.map(site => `<option value="${site.name}" ${window.selectedNegotiateSite===site.name?'selected':''}>${site.name}</option>`).join('')}
            </select>
          </div>
          <div id="chat-list" style="background:var(--bg-card);border-radius:12px;min-height:220px;max-height:320px;overflow-y:auto;padding:18px 12px 12px 12px;margin-bottom:16px;">
            ${chatList.length === 0 ? `<div style='color:var(--text-sub);text-align:center;'>아직 메시지가 없습니다.</div>` : chatList.map((msg, idx) => {
              let canEdit = (currentUser.role === 'master' || currentUser.role === 'admin' || msg.user === currentUser.id);
              let isEditing = window.editingMsgIdx === idx;
              return `<div style="margin-bottom:10px;position:relative;">
                <span style="font-weight:700;color:var(--primary);margin-right:8px;">${msg.user}</span>
                <span style="color:var(--text-main);">
                  ${msg.type === 'img' ? `<img src="${msg.file}" style="max-width:120px;max-height:80px;vertical-align:middle;border-radius:6px;box-shadow:0 2px 8px #0002;margin-right:6px;">` : ''}
                  ${isEditing ? `<input id='edit-msg-input' value='${msg.text||''}' style='padding:4px 8px;border-radius:6px;border:1px solid var(--border);width:180px;'>` : (msg.text||'')}
                </span>
                <span style="color:var(--text-sub);font-size:0.95em;margin-left:8px;">${msg.time}</span>
                ${canEdit ? `
                  <span style="margin-left:8px;">
                    ${isEditing ? `
                      <button onclick="saveEditMsg(${idx})" style="background:var(--success);color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:0.95em;">저장</button>
                      <button onclick="cancelEditMsg()" style="background:var(--danger);color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:0.95em;">취소</button>
                    ` : `
                      <button onclick="editMsg(${idx})" style="background:var(--primary);color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:0.95em;">수정</button>
                      <button onclick="deleteMsg(${idx})" style="background:var(--danger);color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:0.95em;">삭제</button>
                    `}
                  </span>
                ` : ''}
              </div>`;
            }).join('')}
          </div>
          <form id="chat-form" onsubmit="sendChatMessage(event)" style="display:flex;gap:8px;align-items:center;">
            <input id="chat-input" type="text" placeholder="메시지를 입력하세요" autocomplete="off" style="flex:1;padding:10px 12px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.05rem;">
            <label for="chat-file" style="background:var(--bg-card);color:var(--primary);border-radius:8px;padding:8px 12px;cursor:pointer;border:1.5px solid var(--primary);font-size:1.1rem;display:flex;align-items:center;gap:4px;">
              📎<input id="chat-file" type="file" accept="image/*" style="display:none;" onchange="attachChatFile(event)">
            </label>
            <button type="submit" style="background:var(--primary);color:#fff;border:none;border-radius:8px;padding:10px 22px;font-size:1.1rem;font-weight:700;cursor:pointer;">전송</button>
          </form>
          <div id="chat-img-preview" style="margin-top:8px;"></div>
        </div>
      </div>`;
      document.getElementById('main').innerHTML = html;
      window.chatFileData = null;
      document.getElementById('chat-img-preview').innerHTML = '';
    }

    // 협의 전체리스트(데이터베이스2) 화면
    function renderNegotiateList() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let searchValue = window.negListSearchValue || '';
      // 검색 필터
      let filteredSites = sites.filter(site => {
        let chatKey = 'chat_' + site.name;
        let msgCount = (JSON.parse(localStorage.getItem(chatKey) || '[]')).length;
        let remarksKey = 'remarks_' + site.name;
        let remarks = localStorage.getItem(remarksKey) || '';
        const keyword = searchValue.trim().toLowerCase();
        return (
          site.name.toLowerCase().includes(keyword) ||
          remarks.toLowerCase().includes(keyword) ||
          msgCount.toString().includes(keyword)
        );
      });

      let html = `<div class="container card">
        <h2>협의 전체리스트 (데이터베이스2)</h2>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:8px;">
            <input id="neg-list-search" type="text" placeholder="현장명, 비고, 글 수 검색" value="${searchValue||''}" style="padding:8px 14px;border-radius:6px;border:1.5px solid #2d3344;background:var(--bg-main);color:#fff;font-size:1rem;width:220px;" onkeyup="window.negListSearchValue=this.value;renderNegotiateList()">
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="downloadNegotiateList()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">내려받기</button>
            <button onclick="deleteSelectedNegotiateSites()" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">선택 삭제</button>
            <button onclick="renderNegotiate()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">돌아가기</button>
          </div>
        </div>
        <div style="max-height:400px;overflow-y:auto;border-radius:12px;box-shadow:0 2px 8px #0001;background:var(--bg-card);">
        <table style="width:100%;border-collapse:separate;border-spacing:0 8px;">
          <thead>
            <tr style="background:var(--bg-header);color:#fff;">
              <th style="padding:10px 6px;border-bottom:2px solid var(--border);border-radius:8px 0 0 8px;"><input type="checkbox" id="neg-list-select-all" onclick="toggleSelectAllNegSites(this)"></th>
              <th style="padding:10px 12px;border-bottom:2px solid var(--border);">현장명</th>
              <th style="padding:10px 12px;border-bottom:2px solid var(--border);">글 수</th>
              <th style="padding:10px 12px;border-bottom:2px solid var(--border);border-radius:0 8px 8px 0;">비고</th>
            </tr>
          </thead>
          <tbody>
            ${filteredSites.map(site => {
              let chatKey = 'chat_' + site.name;
              let msgCount = (JSON.parse(localStorage.getItem(chatKey) || '[]')).length;
              let remarksKey = 'remarks_' + site.name;
              let remarks = localStorage.getItem(remarksKey) || '';
              let checked = window.negListSelectedRows && window.negListSelectedRows.includes(site.name) ? 'checked' : '';
              return `<tr style="background:var(--bg-main);color:#fff;box-shadow:0 1px 4px #0001;border-radius:8px;">
                <td style="padding:10px 6px;text-align:center;border-radius:8px 0 0 8px;"><input type="checkbox" class="neg-list-row-check" value="${site.name}" ${checked} onclick="toggleSelectNegSiteRow('${site.name}')"></td>
                <td style="padding:10px 12px;font-weight:700;">${site.name}</td>
                <td style="padding:10px 12px;text-align:center;">${msgCount}</td>
                <td style="padding:10px 12px;border-radius:0 8px 8px 0;">
                  ${(currentUser.role==='master'||currentUser.role==='admin')
                    ? `<input type='text' value='${remarks}' onchange="updateRemarks('${site.name}', this.value)" style="width:100%;min-width:80px;max-width:220px;padding:6px 10px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-card);color:#fff;font-size:1rem;">`
                    : `<span style='color:#fff;display:inline-block;min-width:80px;max-width:220px;overflow-x:auto;padding:6px 10px;border-radius:6px;background:var(--bg-card);font-size:1rem;'>${remarks}</span>`}
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
        </div>
      </div>`;
      document.getElementById('main').innerHTML = html;
    }
    // 전체선택 체크박스
    window.toggleSelectAllNegSites = function(checkbox) {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      if (checkbox.checked) {
        window.negListSelectedRows = sites.map(site => site.name);
      } else {
        window.negListSelectedRows = [];
      }
      renderNegotiateList();
    }
    // 개별 체크박스
    window.toggleSelectNegSiteRow = function(name) {
      window.negListSelectedRows = window.negListSelectedRows || [];
      if (window.negListSelectedRows.includes(name)) {
        window.negListSelectedRows = window.negListSelectedRows.filter(n => n !== name);
      } else {
        window.negListSelectedRows.push(name);
      }
      renderNegotiateList();
    }
    // 내려받기(엑셀)
    window.downloadNegotiateList = function() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      const header = ['현장명','글 수','비고'];
      let rows = sites.map(site => {
        let chatKey = 'chat_' + site.name;
        let msgCount = (JSON.parse(localStorage.getItem(chatKey) || '[]')).length;
        let remarksKey = 'remarks_' + site.name;
        let remarks = localStorage.getItem(remarksKey) || '';
        return [site.name, msgCount, remarks].map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',');
      });
      const csv = header.join(',') + '\n' + rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '협의_전체리스트.csv';
      link.click();
    }
    // 선택 삭제
    window.deleteSelectedNegotiateSites = function() {
      let selected = window.negListSelectedRows || [];
      if (!selected.length) return alert('삭제할 현장을 선택하세요!');
      if (!confirm('정말 삭제하시겠습니까?')) return;
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      // 삭제
      sites = sites.filter(site => !selected.includes(site.name));
      selected.forEach(name => {
        localStorage.removeItem('chat_' + name);
        localStorage.removeItem('remarks_' + name);
      });
      localStorage.setItem('sites', JSON.stringify(sites));
      window.negListSelectedRows = [];
      alert('삭제되었습니다.');
      renderNegotiateList();
    }

    // 비고 입력/수정
    window.updateRemarks = function(siteName, value) {
      localStorage.setItem('remarks_' + siteName, value);
    }
    // 현장 선택 변경
    window.changeNegotiateSite = function(siteName) {
      window.selectedNegotiateSite = siteName;
      window.editingMsgIdx = null;
      renderNegotiate();
    }
    // 메시지 전송
    window.sendChatMessage = function(e) {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      let file = window.chatFileData;
      if (!text && !file) return;
      let chatKey = 'chat_' + window.selectedNegotiateSite;
      let chatList = JSON.parse(localStorage.getItem(chatKey) || '[]');
      const now = new Date();
      const time = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
      if (file) {
        chatList.push({ user: currentUser.id, text, time, type: 'img', file });
      } else {
        chatList.push({ user: currentUser.id, text, time });
      }
      localStorage.setItem(chatKey, JSON.stringify(chatList));
      input.value = '';
      window.chatFileData = null;
      renderNegotiate();
      setTimeout(() => {
        const chatListDiv = document.getElementById('chat-list');
        if (chatListDiv) chatListDiv.scrollTop = chatListDiv.scrollHeight;
      }, 50);
    }
    // 파일 첨부
    window.attachChatFile = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        window.chatFileData = ev.target.result;
        document.getElementById('chat-img-preview').innerHTML = `<img src='${window.chatFileData}' style='max-width:120px;max-height:80px;border-radius:6px;box-shadow:0 2px 8px #0002;'>`;
      };
      reader.readAsDataURL(file);
    }
    // 메시지 삭제
    window.deleteMsg = function(idx) {
      let chatKey = 'chat_' + window.selectedNegotiateSite;
      let chatList = JSON.parse(localStorage.getItem(chatKey) || '[]');
      let msg = chatList[idx];
      if (!(currentUser.role === 'master' || currentUser.role === 'admin' || msg.user === currentUser.id)) return;
      if (!confirm('정말 삭제하시겠습니까?')) return;
      chatList.splice(idx, 1);
      localStorage.setItem(chatKey, JSON.stringify(chatList));
      renderNegotiate();
    }
    // 메시지 수정 진입
    window.editMsg = function(idx) {
      window.editingMsgIdx = idx;
      renderNegotiate();
      setTimeout(() => {
        const input = document.getElementById('edit-msg-input');
        if (input) input.focus();
      }, 30);
    }
    // 메시지 수정 저장
    window.saveEditMsg = function(idx) {
      let chatKey = 'chat_' + window.selectedNegotiateSite;
      let chatList = JSON.parse(localStorage.getItem(chatKey) || '[]');
      let msg = chatList[idx];
      if (!(currentUser.role === 'master' || currentUser.role === 'admin' || msg.user === currentUser.id)) return;
      const input = document.getElementById('edit-msg-input');
      if (!input) return;
      msg.text = input.value;
      chatList[idx] = msg;
      localStorage.setItem(chatKey, JSON.stringify(chatList));
      window.editingMsgIdx = null;
      renderNegotiate();
    }
    // 메시지 수정 취소
    window.cancelEditMsg = function() {
      window.editingMsgIdx = null;
      renderNegotiate();
    }

    // 기성현황 화면 구현
    function renderProgress() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      let selectedSite = window.progressSelectedSite || '';
      let selectedMonth = window.progressSelectedMonth || '';
      let selectedRows = window.progressSelectedRows || [];
      // 현장/월 필터
      let filtered = progressList.filter(row => {
        return (!selectedSite || row.site === selectedSite) && (!selectedMonth || row.month === selectedMonth);
      });
      // 월 리스트 생성
      let monthSet = new Set(progressList.map(r=>r.month));
      let monthOptions = Array.from(monthSet).sort().map(m=>`<option value='${m}'>${m}</option>`).join('');
      // 상단 필터/버튼
      let html = `<div class="container card">
        <h2>기성현황</h2>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:18px;">
          <label style="color:var(--text-sub);">현장</label>
          <select id="progress-site" style="padding:8px 14px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:#fff;min-width:120px;" onchange="window.progressSelectedSite=this.value;renderProgress()">
            <option value="">전체</option>
            ${sites.map(s=>`<option value='${s.name}' ${selectedSite===s.name?'selected':''}>${s.name}</option>`).join('')}
          </select>
          <label style="color:var(--text-sub);">월</label>
          <select id="progress-month" style="padding:8px 14px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:#fff;min-width:100px;" onchange="window.progressSelectedMonth=this.value;renderProgress()">
            <option value="">전체</option>
            ${monthOptions}
          </select>
          <button onclick="downloadProgressExcel()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">엑셀 다운로드</button>
          <input type="file" id="progress-upload" accept=".csv" style="display:none;" onchange="uploadProgressCSV(event)">
          <button onclick="document.getElementById('progress-upload').click()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">엑셀 업로드</button>
          <button onclick="addProgressRow()" style="background:var(--success);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">+ 새 기성</button>
          <button onclick="renderProgressList()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">전체 기성</button>
        </div>
        <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:var(--bg-header);color:#fff;">
              <th style="padding:8px 6px;border-bottom:2px solid var(--border);"><input type="checkbox" id="progress-select-all" onclick="toggleSelectAllProgressRows(this)"></th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">현장명</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">계약금액</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">선급금</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">전회기성</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">기성월</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">기성금액</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">비고</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">관리</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.length === 0 ? `<tr><td colspan="9" style="color:var(--text-sub);text-align:center;padding:32px 0;">데이터가 없습니다.</td></tr>` :
              filtered.map((row, idx) => {
                const d = siteDetails[row.site] || {};
                const checked = selectedRows && selectedRows.includes(row.id) ? 'checked' : '';
                return `<tr style="background:var(--bg-card);color:#fff;">
                  <td style="padding:8px 6px;text-align:center;"><input type="checkbox" class="progress-row-check" value="${row.id}" ${checked} onclick="toggleSelectProgressRow(${row.id})"></td>
                  <td style="padding:8px 12px;">${row.site}</td>
                  <td style="padding:8px 12px;text-align:right;">${d.contractAmount ? Number(d.contractAmount).toLocaleString() : ''}</td>
                  <td style="padding:8px 12px;text-align:right;">${d.advanceAmount ? Number(d.advanceAmount).toLocaleString() : ''}</td>
                  <td style="padding:8px 12px;text-align:right;">${d.prevProgress ? Number(d.prevProgress).toLocaleString() : ''}</td>
                  <td style="padding:8px 12px;">${row.month}</td>
                  <td style="padding:8px 12px;text-align:right;">${row.amount.toLocaleString()}</td>
                  <td style="padding:8px 12px;">${row.remarks||''}</td>
                  <td style="padding:8px 12px;">
                    <button onclick="editProgressRow(${row.id})" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:4px 12px;">수정</button>
                    <button onclick="deleteProgressRow(${row.id})" style="background:var(--danger);color:#fff;border:none;border-radius:6px;padding:4px 12px;">삭제</button>
                  </td>
                </tr>`;
              }).join('')
            }
          </tbody>
        </table>
        </div>
      </div>`;
      document.getElementById('main').innerHTML = html;
      if(window.progressEditRow) renderProgressEditForm();
    }

    // 새 기성 추가 폼
    function addProgressRow() {
      window.progressEditRow = { id: Date.now(), site: '', month: '', amount: '', remarks: '' };
      renderProgress();
    }
    // 수정 폼 진입
    function editProgressRow(id) {
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      let row = progressList.find(r => r.id === id);
      if(row) {
        window.progressEditRow = { ...row };
        renderProgress();
      }
    }
    // 삭제
    function deleteProgressRow(id) {
      if(!confirm('정말 삭제하시겠습니까?')) return;
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      progressList = progressList.filter(r => r.id !== id);
      localStorage.setItem('progressList', JSON.stringify(progressList));
      renderProgress();
    }
    // 수정/추가 폼 렌더링
    function renderProgressEditForm() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let row = window.progressEditRow;
      let html = `<div id="progress-edit-modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;display:flex;align-items:center;justify-content:center;">
        <div style="background:var(--bg-card);padding:32px 28px 24px 28px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 4px 32px #0005;position:relative;">
          <button onclick="closeProgressEditForm()" style="position:absolute;right:16px;top:16px;background:none;border:none;color:var(--text-sub);font-size:1.3rem;cursor:pointer;">&times;</button>
          <h3 style="margin:0 0 18px 0;color:var(--primary);">기성 정보 입력</h3>
          <div style="display:flex;flex-direction:column;gap:16px;">
            <div>
              <input id="progress-site-search" type="text" placeholder="현장명 검색" style="width:100%;padding:8px 10px;margin-bottom:8px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1rem;" oninput="filterProgressSiteOptions()">
            </div>
            <div>
              <label style="color:var(--text-sub);margin-bottom:4px;display:block;">현장명</label>
              <select id="edit-progress-site" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;">
                <option value="">선택</option>
                ${sites.map(s=>`<option value='${s.name}' ${row.site===s.name?'selected':''}>${s.name}</option>`).join('')}
              </select>
            </div>
            <div>
              <label style="color:var(--text-sub);margin-bottom:4px;display:block;">기성월</label>
              <input type="month" id="edit-progress-month" value="${row.month||''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;">
            </div>
            <div>
              <label style="color:var(--text-sub);margin-bottom:4px;display:block;">기성금액</label>
              <input type="number" id="edit-progress-amount" value="${row.amount||''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;">
            </div>
            <div>
              <label style="color:var(--text-sub);margin-bottom:4px;display:block;">비고(차수)</label>
              <input type="text" id="edit-progress-remarks" value="${row.remarks||''}" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg-main);color:var(--text-main);font-size:1.1rem;">
            </div>
          </div>
          <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
            <button onclick="saveProgressEditForm()" style="background:var(--success);color:#fff;border:none;border-radius:6px;padding:10px 28px;font-size:1.1rem;font-weight:700;">저장</button>
            <button onclick="closeProgressEditForm()" style="background:var(--danger);color:#fff;border:none;border-radius:6px;padding:10px 28px;font-size:1.1rem;font-weight:700;">취소</button>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
    }

    // 현장명 검색 필터 함수
    function filterProgressSiteOptions() {
      const search = document.getElementById('progress-site-search').value.trim().toLowerCase();
      const select = document.getElementById('edit-progress-site');
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      select.innerHTML = '<option value="">선택</option>' +
        sites.filter(s => s.name.toLowerCase().includes(search)).map(s => `<option value='${s.name}'>${s.name}</option>`).join('');
    }

    function closeProgressEditForm() {
      window.progressEditRow = null;
      let modal = document.getElementById('progress-edit-modal');
      if(modal) modal.remove();
    }
    function saveProgressEditForm() {
      let site = document.getElementById('edit-progress-site').value;
      let month = document.getElementById('edit-progress-month').value;
      let amount = parseInt(document.getElementById('edit-progress-amount').value, 10) || 0;
      let remarks = document.getElementById('edit-progress-remarks').value;
      if(!site || !month || !amount) {
        alert('현장명, 기성월, 기성금액을 모두 입력하세요.');
        return;
      }
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      if(window.progressEditRow && progressList.some(r => r.id === window.progressEditRow.id)) {
        // 수정
        progressList = progressList.map(r => r.id === window.progressEditRow.id ? { ...r, site, month, amount, remarks } : r);
      } else {
        // 추가
        progressList.push({ id: window.progressEditRow.id, site, month, amount, remarks });
      }
      localStorage.setItem('progressList', JSON.stringify(progressList));
      closeProgressEditForm();
      window.progressEditRow = null;
      renderProgress();
    }
    // 엑셀 다운로드
    function downloadProgressExcel() {
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      const header = ['현장명','기성월','기성금액','비고'];
      let rows = progressList.map(row => [row.site, row.month, row.amount, row.remarks||''].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
      const csv = header.join(',') + '\n' + rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '기성현황.csv';
      link.click();
    }
    // 엑셀 업로드
    function uploadProgressCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(Boolean);
        if (lines.length < 2) return alert('데이터가 없습니다.');
        let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
        for (let i=1; i<lines.length; i++) {
          const cols = lines[i].split(',').map(s=>s.replace(/^"|"$/g,''));
          const [site, month, amount, remarks] = cols;
          if (!site || !month || !amount) continue;
          progressList.push({ id: Date.now()+i, site, month, amount: parseInt(amount,10)||0, remarks });
        }
        localStorage.setItem('progressList', JSON.stringify(progressList));
        alert('업로드 완료!');
        renderProgress();
      };
      reader.readAsText(file);
    }

    // 전체 기성 리스트(데이터베이스3) 화면
    function renderProgressList() {
      let sites = JSON.parse(localStorage.getItem('sites') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      let searchValue = window.progressListSearchValue || '';
      let selectedYear = window.progressListSelectedYear || '';
      let selectedMonth = window.progressListSelectedMonth || '';
      let selectedRows = window.progressListSelectedRows || [];
      // 년/월 리스트 생성
      let yearSet = new Set(progressList.map(r=>r.month ? r.month.split('-')[0] : ''));
      let monthSet = new Set(progressList.map(r=>r.month ? r.month.split('-')[1] : ''));
      let yearOptions = Array.from(yearSet).filter(Boolean).sort().map(y=>`<option value='${y}'>${y}</option>`).join('');
      let monthOptions = Array.from(monthSet).filter(Boolean).sort().map(m=>`<option value='${m}'>${m}</option>`).join('');
      // 검색/필터
      let filtered = progressList.filter(row => {
        const d = siteDetails[row.site] || {};
        const keyword = searchValue.trim().toLowerCase();
        const year = row.month ? row.month.split('-')[0] : '';
        const month = row.month ? row.month.split('-')[1] : '';
        return (
          (!selectedYear || year === selectedYear) &&
          (!selectedMonth || month === selectedMonth) &&
          (
            row.site.toLowerCase().includes(keyword) ||
            (d.contractAmount||'').toString().includes(keyword) ||
            (d.advanceAmount||'').toString().includes(keyword) ||
            (d.prevProgress||'').toString().includes(keyword) ||
            (row.amount||'').toString().includes(keyword) ||
            (row.remarks||'').toLowerCase().includes(keyword)
          )
        );
      });
      let html = `<div class="container card">
        <h2>전체 기성 리스트 (데이터베이스3)</h2>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:18px;">
          <input id="progress-list-search" type="text" placeholder="현장명, 금액, 비고 등 검색" value="${searchValue||''}" style="padding:8px 14px;border-radius:6px;border:1.5px solid #2d3344;background:var(--bg-main);color:#fff;font-size:1rem;width:220px;" onkeyup="window.progressListSearchValue=this.value;renderProgressList()">
          <label style="color:var(--text-sub);">년도</label>
          <select id="progress-list-year" style="padding:8px 14px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:#fff;min-width:80px;" onchange="window.progressListSelectedYear=this.value;renderProgressList()">
            <option value="">전체</option>
            ${yearOptions}
          </select>
          <label style="color:var(--text-sub);">월</label>
          <select id="progress-list-month" style="padding:8px 14px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:#fff;min-width:80px;" onchange="window.progressListSelectedMonth=this.value;renderProgressList()">
            <option value="">전체</option>
            ${monthOptions}
          </select>
          <button onclick="downloadProgressListExcel()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">엑셀 다운로드</button>
          <button onclick="renderProgress()" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;">돌아가기</button>
        </div>
        <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:var(--bg-header);color:#fff;">
              <th style="padding:8px 6px;border-bottom:2px solid var(--border);"><input type="checkbox" id="progress-list-select-all" onclick="toggleSelectAllProgressListRows(this)"></th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">현장명</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">계약금액</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">선급금</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">전회기성</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">기성월</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">기성금액</th>
              <th style="padding:8px 12px;border-bottom:2px solid var(--border);">비고</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.length === 0 ? `<tr><td colspan="8" style="color:var(--text-sub);text-align:center;padding:32px 0;">데이터가 없습니다.</td></tr>` :
              filtered.map(row => {
                const d = siteDetails[row.site] || {};
                const checked = selectedRows && selectedRows.includes(row.id) ? 'checked' : '';
                return `<tr style="background:var(--bg-card);color:#fff;">
                  <td style="padding:8px 6px;text-align:center;"><input type="checkbox" class="progress-list-row-check" value="${row.id}" ${checked} onclick="toggleSelectProgressListRow(${row.id})"></td>
                  <td style="padding:8px 12px;">${row.site}</td>
                  <td style="padding:8px 12px;text-align:right;">${d.contractAmount ? Number(d.contractAmount).toLocaleString() : ''}</td>
                  <td style="padding:8px 12px;text-align:right;">${d.advanceAmount ? Number(d.advanceAmount).toLocaleString() : ''}</td>
                  <td style="padding:8px 12px;text-align:right;">${d.prevProgress ? Number(d.prevProgress).toLocaleString() : ''}</td>
                  <td style="padding:8px 12px;">${row.month}</td>
                  <td style="padding:8px 12px;text-align:right;">${row.amount.toLocaleString()}</td>
                  <td style="padding:8px 12px;">${row.remarks||''}</td>
                </tr>`;
              }).join('')
            }
          </tbody>
        </table>
        </div>
      </div>`;
      document.getElementById('main').innerHTML = html;
    }

    // 전체 기성 리스트 체크박스 전체선택/개별선택 함수
    window.toggleSelectAllProgressListRows = function(checkbox) {
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let searchValue = window.progressListSearchValue || '';
      let selectedYear = window.progressListSelectedYear || '';
      let selectedMonth = window.progressListSelectedMonth || '';
      let filtered = progressList.filter(row => {
        const d = siteDetails[row.site] || {};
        const keyword = searchValue.trim().toLowerCase();
        const year = row.month ? row.month.split('-')[0] : '';
        const month = row.month ? row.month.split('-')[1] : '';
        return (
          (!selectedYear || year === selectedYear) &&
          (!selectedMonth || month === selectedMonth) &&
          (
            row.site.toLowerCase().includes(keyword) ||
            (d.contractAmount||'').toString().includes(keyword) ||
            (d.advanceAmount||'').toString().includes(keyword) ||
            (d.prevProgress||'').toString().includes(keyword) ||
            (row.amount||'').toString().includes(keyword) ||
            (row.remarks||'').toLowerCase().includes(keyword)
          )
        );
      });
      if (checkbox.checked) {
        window.progressListSelectedRows = filtered.map(row => row.id);
      } else {
        window.progressListSelectedRows = [];
      }
      renderProgressList();
    }
    window.toggleSelectProgressListRow = function(id) {
      window.progressListSelectedRows = window.progressListSelectedRows || [];
      if (window.progressListSelectedRows.includes(id)) {
        window.progressListSelectedRows = window.progressListSelectedRows.filter(n => n !== id);
      } else {
        window.progressListSelectedRows.push(id);
      }
      renderProgressList();
    }
    // 전체 기성 리스트 엑셀 다운로드
    function downloadProgressListExcel() {
      let siteDetails = JSON.parse(localStorage.getItem('siteDetails') || '{}');
      let progressList = JSON.parse(localStorage.getItem('progressList') || '[]');
      let searchValue = window.progressListSearchValue || '';
      let selectedYear = window.progressListSelectedYear || '';
      let selectedMonth = window.progressListSelectedMonth || '';
      let filtered = progressList.filter(row => {
        const d = siteDetails[row.site] || {};
        const keyword = searchValue.trim().toLowerCase();
        const year = row.month ? row.month.split('-')[0] : '';
        const month = row.month ? row.month.split('-')[1] : '';
        return (
          (!selectedYear || year === selectedYear) &&
          (!selectedMonth || month === selectedMonth) &&
          (
            row.site.toLowerCase().includes(keyword) ||
            (d.contractAmount||'').toString().includes(keyword) ||
            (d.advanceAmount||'').toString().includes(keyword) ||
            (d.prevProgress||'').toString().includes(keyword) ||
            (row.amount||'').toString().includes(keyword) ||
            (row.remarks||'').toLowerCase().includes(keyword)
          )
        );
      });
      const header = ['현장명','계약금액','선급금','전회기성','기성월','기성금액','비고'];
      let rows = filtered.map(row => {
        const d = siteDetails[row.site] || {};
        return [row.site, d.contractAmount||'', d.advanceAmount||'', d.prevProgress||'', row.month, row.amount, row.remarks||''].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
      });
      const csv = header.join(',') + '\n' + rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '전체기성리스트.csv';
      link.click();
    }

    function toggleMobileNav() {
      const nav = document.getElementById('nav');
      nav.classList.toggle('open');
      // 바깥 클릭 시 닫기
      if (nav.classList.contains('open')) {
        document.body.addEventListener('click', closeNavOnClickOutside, true);
      } else {
        document.body.removeEventListener('click', closeNavOnClickOutside, true);
      }
    }
    function closeNavOnClickOutside(e) {
      const nav = document.getElementById('nav');
      const toggle = document.getElementById('nav-toggle');
      if (!nav.contains(e.target) && !toggle.contains(e.target)) {
        nav.classList.remove('open');
        document.body.removeEventListener('click', closeNavOnClickOutside, true);
      }
    }

    // 거래처 현황 화면 렌더링
    function renderPartner() {
      window.partnerTab = window.partnerTab || '건설업체';
      const tabs = ['건설업체', 'AL관급업체', 'PL관급업체'];
      let partnerData = JSON.parse(localStorage.getItem('partnerData') || '{}');
      tabs.forEach(tab => { if (!partnerData[tab]) partnerData[tab] = []; });
      // 정렬 상태
      window.partnerSortKey = window.partnerSortKey || '업체명';
      window.partnerSortAsc = window.partnerSortAsc !== false;
      // 상단 탭
      let tabHtml = `<div style="display:flex;gap:8px;margin-bottom:24px;align-items:center;">
        ${tabs.map(tab => `<button onclick="window.partnerTab='${tab}';window.partnerSortKey='업체명';window.partnerSortAsc=true;window.partnerSelectedRows=[];renderPartner();" style="padding:8px 22px;border:none;border-radius:18px;font-size:1.08rem;font-weight:700;cursor:pointer;background:${window.partnerTab===tab?'var(--primary)':'var(--bg-card)'};color:${window.partnerTab===tab?'#fff':'var(--text-sub)'};box-shadow:${window.partnerTab===tab?'0 4px 16px #3b82f655':'none'};">${tab}</button>`).join('')}
        <button onclick='downloadAllPartnerExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;margin-left:16px;'>전체 다운로드</button>
      </div>`;
      // 컬럼 정의
      const columnsMap = {
        '건설업체': [
          {name:'업체명'},
          {name:'납품/계약일자', width:'110px'},
          {name:'계약건명', width:'260px'},
          {name:'금액'},
          {name:'품목'},
          {name:'물량'},
          {name:'비고'}
        ],
        'AL관급업체': [
          {name:'업체명'},
          {name:'납품/계약일자', width:'110px'},
          {name:'계약건명', width:'260px'},
          {name:'금액'},
          {name:'비고'}
        ],
        'PL관급업체': [
          {name:'업체명'},
          {name:'납품/계약일자', width:'110px'},
          {name:'계약건명', width:'260px'},
          {name:'금액'},
          {name:'비고'}
        ]
      };
      const columns = columnsMap[window.partnerTab];
      window.partnerSortAsc = window.partnerSortAsc !== false;
      // 검색
      let searchValue = window.partnerSearchValue || '';
      let rows = partnerData[window.partnerTab].filter(row =>
        columns.some(col => (row[col]||'').toLowerCase().includes(searchValue.trim().toLowerCase()))
      );
      // 정렬
      rows = rows.slice().sort((a,b)=>{
        let v1 = (a[window.partnerSortKey]||'').toLowerCase();
        let v2 = (b[window.partnerSortKey]||'').toLowerCase();
        if(v1 < v2) return window.partnerSortAsc ? -1 : 1;
        if(v1 > v2) return window.partnerSortAsc ? 1 : -1;
        return 0;
      });
      // 선택 체크박스
      window.partnerSelectedRows = window.partnerSelectedRows || [];
      function isChecked(idx) { return window.partnerSelectedRows.includes(idx); }
      function isAllChecked() { return rows.length>0 && rows.every((_,i)=>isChecked(i)); }
      // 테이블
      let tableHtml = `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;">
        <thead><tr style="background:var(--bg-header);color:#fff;">
          <th style='padding:8px 6px;border-bottom:2px solid var(--border);'><input type='checkbox' onclick='togglePartnerSelectAll(this)'
            ${isAllChecked()?'checked':''}></th>
          ${columns.map(col=>`<th style='padding:8px 10px;border-bottom:2px solid var(--border);${col.width?`width:${col.width};min-width:${col.width};max-width:${col.width};`:''}cursor:pointer;' onclick='sortPartnerBy("${col.name}")'>${col.name} <span style='font-size:0.9em;'>${window.partnerSortKey===col.name?(window.partnerSortAsc?'▲':'▼'):''}</span></th>`).join('')}
          <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>관리</th>
        </tr></thead>
        <tbody style='${rows.length>10?"display:block;max-height:420px;overflow-y:auto;":""}'>
          ${rows.length===0 ? `<tr><td colspan='${columns.length+2}' style='color:var(--text-sub);text-align:center;padding:32px 0;'>데이터가 없습니다.</td></tr>` :
            rows.map((row,idx)=>`<tr style='background:var(--bg-card);color:#fff;${rows.length>10?"display:table;width:100%;table-layout:fixed;":""}'>
              <td style='padding:8px 6px;border-bottom:1px solid var(--border);text-align:center;'><input type='checkbox' ${isChecked(idx)?'checked':''} onclick='togglePartnerSelectRow(${idx})'></td>
              ${columns.map((col,ci)=>`<td style='padding:8px 10px;border-bottom:1px solid var(--border);${col.width?`width:${col.width};min-width:${col.width};max-width:${col.width};`:''}'>${row[col.name]||''}</td>`).join('')}
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>
                <button onclick='editPartnerRow(${idx})' style='background:var(--primary);color:#fff;border:none;border-radius:6px;padding:4px 12px;'>수정</button>
                <button onclick='deletePartnerRow(${idx})' style='background:var(--danger);color:#fff;border:none;border-radius:6px;padding:4px 12px;'>삭제</button>
              </td>
            </tr>`).join('')
          }
        </tbody></table></div>`;
      // 신규 등록 폼
      let formHtml = '';
      if(window.partnerEditIdx===undefined) {
        formHtml = `<form onsubmit='addPartnerRow(event)' style='display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;'>
          ${columns.map(col=>`<input name='${col.name}' placeholder='${col.name}' style='padding:8px 10px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:#fff;font-size:1rem;min-width:120px;flex:1;'>`).join('')}
          <button type='submit' style='background:var(--success);color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;'>+ 신규 등록</button>
        </form>`;
      } else {
        let row = partnerData[window.partnerTab][window.partnerEditIdx];
        formHtml = `<form onsubmit='savePartnerEdit(event)' style='display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;'>
          ${columns.map(col=>`<input name='${col.name}' value='${row[col.name]||''}' placeholder='${col.name}' style='padding:8px 10px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg-main);color:#fff;font-size:1rem;min-width:120px;flex:1;'>`).join('')}
          <button type='submit' style='background:var(--success);color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;'>저장</button>
          <button type='button' onclick='cancelPartnerEdit()' style='background:var(--danger);color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;'>취소</button>
        </form>`;
      }
      // 검색창/엑셀/선택삭제 버튼
      let topBar = `<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap;'>
        <input type='text' placeholder='검색' value='${searchValue||''}' onkeyup='window.partnerSearchValue=this.value;renderPartner();' style='padding:8px 14px;border-radius:6px;border:1.5px solid #2d3344;background:#232837;color:#fff;font-size:1rem;width:220px;'>
        <div style='display:flex;gap:8px;flex-wrap:wrap;'>
          <button onclick='downloadPartnerExcel()' style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;'>엑셀 다운로드</button>
          <input type='file' id='partner-upload' accept='.csv' style='display:none;' onchange='uploadPartnerCSV(event)'>
          <button onclick="document.getElementById('partner-upload').click()" style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;'>엑셀 업로드</button>
          <button onclick='deleteSelectedPartnerRows()' style='background:var(--danger);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:700;'>선택 삭제</button>
        </div>
      </div>`;
      document.getElementById('main').innerHTML = `<div class='container card'><h2>거래처 현황</h2>${tabHtml}${topBar}${formHtml}${tableHtml}</div>`;
    }
    // 체크박스 전체선택
    window.togglePartnerSelectAll = function(checkbox) {
      let partnerData = JSON.parse(localStorage.getItem('partnerData') || '{}');
      let rows = partnerData[window.partnerTab] || [];
      window.partnerSelectedRows = checkbox.checked ? rows.map((_,i)=>i) : [];
      renderPartner();
    }
    // 체크박스 개별선택
    window.togglePartnerSelectRow = function(idx) {
      window.partnerSelectedRows = window.partnerSelectedRows || [];
      if(window.partnerSelectedRows.includes(idx)) {
        window.partnerSelectedRows = window.partnerSelectedRows.filter(i=>i!==idx);
      } else {
        window.partnerSelectedRows.push(idx);
      }
      renderPartner();
    }
    // 선택 삭제
    window.deleteSelectedPartnerRows = function() {
      if(!window.partnerSelectedRows || window.partnerSelectedRows.length===0) return alert('삭제할 항목을 선택하세요!');
      if(!confirm('정말 삭제하시겠습니까?')) return;
      let partnerData = JSON.parse(localStorage.getItem('partnerData') || '{}');
      let rows = partnerData[window.partnerTab] || [];
      window.partnerSelectedRows.sort((a,b)=>b-a).forEach(idx=>rows.splice(idx,1));
      partnerData[window.partnerTab] = rows;
      localStorage.setItem('partnerData', JSON.stringify(partnerData));
      window.partnerSelectedRows = [];
      renderPartner();
    }
    // 정렬
    window.sortPartnerBy = function(col) {
      if(window.partnerSortKey===col) window.partnerSortAsc = !window.partnerSortAsc;
      else { window.partnerSortKey=col; window.partnerSortAsc=true; }
      renderPartner();
    }

    // 회원명단 화면 및 회원 데이터 관리 함수 추가
    function renderMembers() {
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      if (!members.find(m=>m.id==='fire8803')) members.push({id:'fire8803',name:'관리자',org:'총괄',pw:'power520',role:'master',status:'승인'});
      if (!members.find(m=>m.id==='admin')) members.push({id:'admin',name:'관리자',org:'A회사',pw:'8657',role:'admin',status:'승인'});
      localStorage.setItem('members', JSON.stringify(members));
      let reqList = members.filter(m=>m.status==='요청');
      let userList = members.filter(m=>m.status==='승인'&&m.role==='user');
      let adminList = members.filter(m=>m.status==='승인'&&m.role==='admin');
      let master = members.find(m=>m.id==='fire8803');
      function memberTable(list, type, tableIdx) {
        const needScroll = list.length > 5;
        return `<div style='overflow-x:auto;max-height:${needScroll?"270px":"none"};overflow-y:${needScroll?"auto":"visible"};border-radius:10px;'>
          <table style='width:100%;border-collapse:collapse;background:var(--bg-card);color:#fff;'>
            <thead><tr style='background:var(--bg-header);color:#fff;'>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>아이디</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>이름</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>소속</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>비밀번호</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>마스터</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>관리자</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>일반회원</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>요청</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>회원거절</th><th style='padding:8px 10px;border-bottom:2px solid var(--border);'>권한변경</th>
            </tr></thead><tbody>
              ${list.map((m,idx)=>`<tr style='background:var(--bg-card);color:#fff;height:50px;'>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.id}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.name}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.org}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>
                  <span id='pw-hide-mem-${tableIdx}-${idx}'>●●●●●</span><span id='pw-show-mem-${tableIdx}-${idx}' style='display:none;'>${m.pw}</span>
                  <span style='cursor:pointer;vertical-align:middle;margin-left:4px;' onclick='togglePwShowMem(${tableIdx},${idx})'>👁️</span>
                </td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);text-align:center;'>${m.role==='master'?'●':''}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);text-align:center;'>${m.role==='admin'?'●':''}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);text-align:center;'>${m.role==='user'&&m.status==='승인'?'●':''}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);text-align:center;'>${m.status==='요청'?'●':''}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);text-align:center;'>${m.status==='거절'?'●':''}</td>
                <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${renderRoleSelect(m,type)}</td>
              </tr>`).join('')}
            </tbody></table></div>`;
      }
      let html = `<div class='container card'><div style='display:flex;justify-content:space-between;align-items:center;'><h2>회원명단</h2><button onclick='renderAllMembers()' style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-weight:700;font-size:1rem;'>회원 전체 리스트</button></div>
        <div style='font-size:1.3rem;font-weight:700;color:#2563eb;margin-bottom:18px;'>회원현황</div>
        <div style='margin-bottom:36px;'>
          <div style='font-size:1.1rem;font-weight:700;margin-bottom:6px;'>신청목록</div>
          ${memberTable(reqList,'req',0)}
        </div>
        <div style='margin-bottom:36px;'>
          <div style='font-size:1.1rem;font-weight:700;margin-bottom:6px;'>일반회원</div>
          ${memberTable(userList,'user',1)}
        </div>
        <div style='margin-bottom:0;'>
          <div style='font-size:1.1rem;font-weight:700;margin-bottom:6px;'>관리자</div>
          ${memberTable(adminList,'admin',2)}
        </div>
      </div>`;
      document.getElementById('main').innerHTML = html;
    }
    // 권한변경 함수
    window.changeMemberRole = function(id, value) {
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      let m = members.find(m=>m.id===id);
      if(!m) return;
      if(id==='fire8803') return alert('마스터는 변경할 수 없습니다.');
      if(currentUser.role!=='master'&&m.role==='admin') return alert('관리자는 마스터만 변경할 수 있습니다.');
      if(value==='admin') { m.role='admin'; m.status='승인'; }
      else if(value==='user'||value==='승인') { m.role='user'; m.status='승인'; }
      else if(value==='요청') { m.status='요청'; m.role='user'; }
      else if(value==='거절') { m.status='거절'; m.role='user'; }
      localStorage.setItem('members', JSON.stringify(members));
      renderMembers();
    }
    // 회원가입 시 요청회원으로 등록
    window.signup = function() {
      const id = document.getElementById('signup-id').value.trim();
      const pw = document.getElementById('signup-pw').value.trim();
      const name = document.getElementById('signup-name').value.trim();
      const org = document.getElementById('signup-org').value.trim();
      if(!id||!pw||!name||!org) return alert('모든 항목을 입력하세요.');
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      if(members.find(m=>m.id===id)) return alert('이미 존재하는 아이디입니다.');
      members.push({id,name,org,pw,role:'user',status:'요청'});
      localStorage.setItem('members', JSON.stringify(members));
      alert('회원가입 신청이 완료되었습니다. 관리자의 승인을 기다려주세요.');
      renderLogin();
    }
    // 로그인 시 승인 여부 체크
    function login() {
      const id = document.getElementById("login-id").value.trim();
      const pw = document.getElementById("login-pw").value.trim();
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      const user = members.find(u => u.id === id && u.pw === pw);
      if (!user) {
        document.getElementById("login-error").textContent = "아이디 또는 비밀번호가 올바르지 않습니다.";
        return;
      }
      if(user.status!=='승인') {
        document.getElementById("login-error").textContent = "관리자에게 승인을 요청했습니다.";
        return;
      }
      currentUser = user;
      setToday();
      renderHeader();
      renderMenu("main");
    }
    // 회원가입 화면 렌더링 보완
    function renderSignup() {
      document.getElementById("header").style.display = "none";
      document.getElementById("main").innerHTML = `
        <div class="login-box">
          <h2>회원가입</h2>
          <input id="signup-id" type="text" placeholder="아이디" autocomplete="username"/>
          <input id="signup-pw" type="password" placeholder="비밀번호" autocomplete="new-password"/>
          <input id="signup-name" type="text" placeholder="이름"/>
          <input id="signup-org" type="text" placeholder="소속"/>
          <button class="login-btn" onclick="signup()">회원가입</button>
          <button class="signup-btn" onclick="renderLogin()">로그인으로</button>
          <div class="error-msg" id="signup-error"></div>
        </div>
      `;
    }

    // 페이지 로드 시 마스터/관리자 계정 보장
    (function(){
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      if (!members.find(m=>m.id==='fire8803')) {
        members.push({id:'fire8803',name:'관리자',org:'총괄',pw:'power520',role:'master',status:'승인'});
      }
      if (!members.find(m=>m.id==='parkmg0688')) {
        members.push({id:'parkmg0688',name:'관리자',org:'A회사',pw:'Lastout9485!',role:'admin',status:'승인'});
      }
      localStorage.setItem('members', JSON.stringify(members));
    })();

    // 전체 다운로드(xlsx 여러 시트) 함수 추가
    window.downloadAllPartnerExcel = function() {
      // xlsx CDN 동적 로드
      if (!window.XLSX) {
        let script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.onload = downloadAllPartnerExcel;
        document.body.appendChild(script);
        return;
      }
      let partnerData = JSON.parse(localStorage.getItem('partnerData') || '{}');
      let columnsMap = {
        '건설업체': ['업체명','납품/계약일자','계약건명','금액','품목','물량','비고'],
        'AL관급업체': ['업체명','납품/계약일자','계약건명','금액','비고'],
        'PL관급업체': ['업체명','납품/계약일자','계약건명','금액','비고']
      };
      let wb = XLSX.utils.book_new();
      Object.keys(columnsMap).forEach(tab => {
        let columns = columnsMap[tab];
        let rows = partnerData[tab] || [];
        let data = [columns].concat(rows.map(row => columns.map(col => row[col]||'')));
        let ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, tab);
      });
      XLSX.writeFile(wb, '거래처_전체리스트.xlsx');
    }

    // 메뉴권한 화면 함수 추가
    function renderMenuAuth() {
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      let menuAuth = JSON.parse(localStorage.getItem('menuAuth') || '{}');
      let tempMenuAuth = JSON.parse(JSON.stringify(menuAuth)); // 임시 상태
      const menus = [
        { key: "main", label: "건설NEWS" },
        { key: "status", label: "공사현황" },
        { key: "detail", label: "현장세부내역" },
        { key: "negotiate", label: "협의하기" },
        { key: "progress", label: "기성현황" },
        { key: "partner", label: "거래처 현황" },
        { key: "members", label: "회원명단" },
        { key: "menuauth", label: "메뉴권한" },
        { key: "allmembers", label: "회원 전체 리스트", roles: ["master","admin"] },
      ];
      // 표 헤더
      let table = `<div style='overflow-x:auto;'><table style='width:100%;border-collapse:collapse;background:var(--bg-card);color:#fff;'>
        <thead><tr style='background:var(--bg-header);color:#fff;'>
          <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>아이디</th>
          <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>이름</th>
          <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>권한</th>
          ${menus.map(m=>`<th style='padding:8px 10px;border-bottom:2px solid var(--border);'>${m.label}</th>`).join('')}
          <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>삭제</th>
        </tr></thead><tbody>`;
      members.forEach(m => {
        table += `<tr style='background:var(--bg-card);color:#fff;'>
          <td style='padding:8px 10px;border-bottom:1px solid var(--border);font-weight:700;color:#3b82f6;'>${m.id}</td>
          <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.name}</td>
          <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.role==='master'?'마스터':m.role==='admin'?'관리자':'일반회원'}</td>`;
        menus.forEach(menu => {
          if(m.role==='master') {
            if(tempMenuAuth[m.id]===undefined) tempMenuAuth[m.id]={};
            tempMenuAuth[m.id][menu.key]=true;
            table += `<td style='text-align:center;color:#22c55e;font-size:1.2em;border-bottom:1px solid var(--border);'>●</td>`;
          } else {
            if(tempMenuAuth[m.id]===undefined) tempMenuAuth[m.id]={};
            if(tempMenuAuth[m.id][menu.key]===undefined) {
              tempMenuAuth[m.id][menu.key]=m.role==='admin'||m.role==='master'?true:['main','status','detail','negotiate','partner'].includes(menu.key);
            }
            // 마스터/관리자만 체크박스 활성화
            if(currentUser.role==='master'||currentUser.role==='admin') {
              table += `<td style='text-align:center;border-bottom:1px solid var(--border);'><input type='checkbox' ${tempMenuAuth[m.id][menu.key]?'checked':''} onchange='tempChangeMenuAuth("${m.id}","${menu.key}",this.checked)' style='width:18px;height:18px;'></td>`;
            } else {
              table += `<td style='text-align:center;color:${tempMenuAuth[m.id][menu.key]?'#2563eb':'#b3b8c5'};font-size:1.2em;border-bottom:1px solid var(--border);'>${tempMenuAuth[m.id][menu.key]?'●':''}</td>`;
            }
          }
        });
        // 삭제 버튼(마스터/본인 삭제 불가)
        if(m.role==='master'||m.id===currentUser.id) {
          table += `<td style='text-align:center;color:#b3b8c5;border-bottom:1px solid var(--border);'>-</td>`;
        } else {
          table += `<td style='text-align:center;border-bottom:1px solid var(--border);'><button onclick='deleteMember("${m.id}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;cursor:pointer;'>삭제</button></td>`;
        }
        table += `</tr>`;
      });
      table += `</tbody></table></div>`;
      let html = `<div class='container card'><h2>메뉴권한</h2>
        <div style='font-size:1.15rem;font-weight:700;color:#2563eb;margin-bottom:18px;'>회원별 메뉴 접근 권한 관리</div>
        ${table}
        <div style='margin-top:18px;display:flex;gap:12px;'>
          <button onclick='saveMenuAuth()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:10px 28px;font-size:1.1rem;font-weight:700;'>저장</button>
        </div>
        <div style='color:#b3b8c5;font-size:0.98rem;margin-top:12px;'>마스터는 모든 메뉴 접근 가능하며, 권한 변경/삭제가 불가능합니다.<br>관리자/마스터만 권한 변경 및 회원 삭제가 가능합니다.<br>저장 버튼을 눌러야 변경사항이 반영됩니다.</div>
      </div>`;
      window._tempMenuAuth = tempMenuAuth; // 임시 상태를 window에 저장
      document.getElementById('main').innerHTML = html;
    }
    // 체크박스 임시 변경 함수
    window.tempChangeMenuAuth = function(id, menuKey, checked) {
      if(!window._tempMenuAuth) return;
      if(!window._tempMenuAuth[id]) window._tempMenuAuth[id]={};
      window._tempMenuAuth[id][menuKey]=checked;
    }
    // 저장 버튼 함수
    window.saveMenuAuth = function() {
      if(!window._tempMenuAuth) return;
      localStorage.setItem('menuAuth', JSON.stringify(window._tempMenuAuth));
      alert('저장되었습니다.');
      renderMenuAuth();
    }
    // 회원 삭제 함수
    window.deleteMember = function(id) {
      if(!confirm('정말 삭제하시겠습니까?')) return;
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      members = members.filter(m=>m.id!==id);
      localStorage.setItem('members', JSON.stringify(members));
      let menuAuth = JSON.parse(localStorage.getItem('menuAuth') || '{}');
      delete menuAuth[id];
      localStorage.setItem('menuAuth', JSON.stringify(menuAuth));
      renderMenuAuth();
    }
    // 회원 전체 리스트(데이터베이스4) 화면 함수 추가
    function renderAllMembers() {
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      const needScroll = members.length > 5;
      let html = `<div class='container card'>
        <div style='font-size:1.1rem;font-weight:700;color:#2563eb;margin-bottom:18px;'>전체 회원 정보</div>
        <div style='overflow-x:auto;max-height:${needScroll?"270px":"none"};overflow-y:${needScroll?"auto":"visible"};border-radius:10px;'>
          <table style='width:100%;border-collapse:collapse;background:var(--bg-card);color:#fff;'>
            <thead><tr style='background:var(--bg-header);color:#fff;'>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>아이디</th>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>이름</th>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>소속</th>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>비밀번호</th>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>권한</th>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>상태</th>
              <th style='padding:8px 10px;border-bottom:2px solid var(--border);'>삭제</th>
            </tr></thead><tbody>
            ${members.map((m,idx)=>`<tr style='background:var(--bg-card);color:#fff;height:50px;'>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);font-weight:700;color:#3b82f6;'>${m.id}</td>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.name}</td>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.org}</td>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);'><span id='pw-hide-${idx}'>●●●●●</span><span id='pw-show-${idx}' style='display:none;'>${m.pw}</span> <span style='cursor:pointer;vertical-align:middle;' onclick='togglePwShow(${idx})'>👁️</span></td>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.role==='master'?'마스터':m.role==='admin'?'관리자':'일반회원'}</td>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);'>${m.status}</td>
              <td style='padding:8px 10px;border-bottom:1px solid var(--border);text-align:center;'>${(m.role==='master'||m.id===currentUser.id)?'-':`<button onclick='deleteMemberAllList("${m.id}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;cursor:pointer;'>삭제</button>`}</td>
            </tr>`).join('')}
            </tbody></table>
        </div>
        <div style='color:#b3b8c5;font-size:0.98rem;margin-top:12px;'>삭제 버튼을 누르기 전까지 회원 데이터는 항상 보존됩니다.</div>
      </div>`;
      document.getElementById('main').innerHTML = html;
    }
    // 회원 전체 리스트에서 삭제 함수(실제 삭제)
    window.deleteMemberAllList = function(id) {
      if(!confirm('정말 삭제하시겠습니까?')) return;
      let members = JSON.parse(localStorage.getItem('members') || '[]');
      members = members.filter(m=>m.id!==id);
      localStorage.setItem('members', JSON.stringify(members));
      let menuAuth = JSON.parse(localStorage.getItem('menuAuth') || '{}');
      delete menuAuth[id];
      localStorage.setItem('menuAuth', JSON.stringify(menuAuth));
      renderAllMembers();
    }
    // 비밀번호 눈 아이콘 토글 함수
    window.togglePwShow = function(idx) {
      const hide = document.getElementById('pw-hide-'+idx);
      const show = document.getElementById('pw-show-'+idx);
      if(hide.style.display==='none') {
        hide.style.display='';
        show.style.display='none';
      } else {
        hide.style.display='none';
        show.style.display='';
      }
    }
    // 회원명단 비밀번호 눈 아이콘 토글 함수
    window.togglePwShowMem = function(tableIdx, idx) {
      const hide = document.getElementById('pw-hide-mem-'+tableIdx+'-'+idx);
      const show = document.getElementById('pw-show-mem-'+tableIdx+'-'+idx);
      if(hide.style.display==='none') {
        hide.style.display='';
        show.style.display='none';
      } else {
        hide.style.display='none';
        show.style.display='';
      }
    }
  </script>
</body>
</html>
